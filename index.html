<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WormJB</title>
  <style>
    :root {
      --ios-blue: #007aff;
      --ios-gray: #f2f2f7;
      --ios-border: #c6c6c8;
      --ios-bg: #ffffff;
      --ios-text-gray: #555;
    }
    html, body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--ios-bg);
      color: #000;
      height: 100%;
      overflow: hidden;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 56px; display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 1.2rem;
      border-bottom: 1px solid var(--ios-border);
      background: white; z-index: 10;
    }
    .version {
      position: fixed; top: 56px; width: 100%; text-align: center;
      font-size: 0.8rem; color: #666; background: white; padding: 0.3rem 0;
      z-index: 9;
    }
    main {
      position: absolute; top: 84px; bottom: 60px; left: 0; right: 0;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      background: var(--ios-bg);
      padding: 1rem; box-sizing: border-box;
    }
    section { display: none; }
    section.active { display: block; }

    .ios-card {
      background: white; border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 1rem; margin: 1rem 0;
    }
    .ios-list {
      background: white; border-radius: 12px;
      overflow: hidden; border: 1px solid var(--ios-border);
    }
    .ios-list-item {
      padding: 1rem; border-bottom: 1px solid var(--ios-border);
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1rem;
    }
    .ios-list-item:last-child { border-bottom: none; }
    .ios-button {
      background: var(--ios-blue); color: white; border: none;
      border-radius: 12px; font-size: 1rem; padding: 0.7rem 1.5rem;
      font-weight: 500; cursor: pointer; transition: opacity 0.2s;
    }
    .ios-button:active { opacity: 0.6; }
    .ios-button.danger { background: #ff3b30; }
    .ios-input {
      border: 1px solid var(--ios-border);
      border-radius: 12px; padding: 0.6rem 1rem;
      font-size: 1rem; width: 100%;
      background: var(--ios-gray); box-sizing: border-box;
      margin: 0.5rem 0;
    }
    .ios-switch { position: relative; width: 50px; height: 28px; }
    .ios-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; border-radius: 34px; transition: .3s;
    }
    .slider:before {
      position: absolute; content: "";
      height: 22px; width: 22px; left: 3px; bottom: 3px;
      background-color: white; border-radius: 50%; transition: .3s;
    }
    .ios-switch input:checked + .slider { background-color: var(--ios-blue); }
    .ios-switch input:checked + .slider:before { transform: translateX(22px); }
    .ios-alert {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; border-radius: 14px; padding: 1.2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center; display: none; width: 80%; max-width: 320px;
    }
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; border-top: 1px solid var(--ios-border);
      background: white; height: 60px; z-index: 10;
    }
    .tab {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #8e8e93; font-size: 0.7rem; cursor: pointer;
      user-select: none;
    }
    .tab.active { color: var(--ios-blue); }
    svg { width: 22px; height: 22px; margin-bottom: 2px; }

    /* When forcing Apple-like font (Inter) */
    html.force-apple-font, html.force-apple-font body {
      font-family: 'Inter', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
  </style>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between; padding:0 1rem;">
    <div style="font-weight:600; font-size:1.2rem; text-align:left;">WormJB</div>
    <div id="headerProfileWrap" style="display:flex; align-items:center; gap:.5rem;">
      <span id="headerUsername" style="color:#666; font-size:0.95rem;">User Name</span>
      <!-- Profile button/icon. In Icon Mode this will be shown as an unstyled icon button; in Button Mode it will have .ios-button styling and include the username label inside the button -->
      <button id="profileBtn" class="ios-button" style="padding:0.3rem 0.6rem; display:flex; align-items:center; gap:.5rem;">
        <img id="profileIcon" src="assets/wormjbicon.png" alt="icon" style="width:20px; height:20px; border-radius:4px;" />
        <span id="profileBtnLabel" style="font-size:0.9rem;">Profile</span>
      </button>
    </div>
  </header>
  <div class="version">app version 0.2.3</div>

  <main>
    <section id="home" class="active">
      <div class="ios-card">
        <h3>wormJB Actions</h3>
        <!-- Re-Jailbreak section (separated) -->
        <div class="ios-list" style="margin-bottom:0.75rem;">
          <div class="ios-list-item" style="flex-direction:column; align-items:stretch; gap:.5rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
              <span style="font-weight:500;">Re-Jailbreak</span>
              <label class="ios-switch" title="Clean reinstall (runs revert first)">
                <input type="checkbox" id="cleanReJB"><span class="slider"></span>
              </label>
            </div>
            <button class="ios-button" id="reJBBtn">Re-Jailbreak</button>
            <p id="statusText" style="color: var(--ios-text-gray); margin:0.25rem 0 0 0;">Status: Idle</p>
          </div>
        </div>

        <!-- Compact action buttons (no extra titles) -->
        <div class="ios-list" style="margin-top:0.5rem;">
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button danger" id="removeJBBtn" style="width:100%;">Remove Jailbreak</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="installSideStoreBtn" style="width:100%;">Install SideStore</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="openRepoBtn" style="width:100%;">Open GitHub Repo</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="showScriptBtn" style="width:100%;">Show Script</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="mysteryBtn" style="width:100%;">Do Nothing</button>
          </div>
        </div>

        <div style="margin-top:.75rem; display:flex; gap:.5rem; align-items:center;">
          <button class="ios-button" id="audioToggleBtn">Play Looping Audio</button>
          <span style="color:var(--ios-text-gray); font-size:0.9rem;">Looping: <strong id="audioState">off</strong></span>
        </div>
      </div>
    </section>

    <section id="tweaks">
      <div style="display:flex; justify-content:flex-end; margin-bottom:.5rem;">
        <button id="addTweakBtn" class="ios-button" style="display:none;">Add Tweak</button>
      </div>
      <div id="tweak-container" class="ios-list" style="padding:0;">
        <!-- Tweaks will be rendered here by JS -->
      </div>

      <!-- Tweak edit modal (dev only) -->
      <div id="tweakModal" class="ios-alert" style="display:none;">
        <h3>Edit Tweak</h3>
        <div style="text-align:left; margin-top:.5rem;">
          <label>Name</label>
          <input id="tweakName" class="ios-input" />
          <label>ID</label>
          <input id="tweakId" class="ios-input" />
          <label>Description</label>
          <input id="tweakDesc" class="ios-input" />
          <label>Author</label>
          <input id="tweakAuthor" class="ios-input" />
          <label>Version</label>
          <input id="tweakVersion" class="ios-input" />
          <label>Date</label>
          <input id="tweakDate" class="ios-input" />
          <label>Background Color</label>
          <input id="tweakBg" class="ios-input" placeholder="#ffffff" />
        </div>
        <div style="display:flex; gap:.5rem; margin-top: .75rem; justify-content:center;">
          <button class="ios-button" id="saveTweakBtn">Save</button>
          <button class="ios-button" onclick="hideAlert()">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Profile panel (not a tab) -->
    <section id="profilePanel" style="display:none;">
      <div class="ios-card">
        <h3>Profile</h3>
        <div class="ios-list" style="padding:1rem;">
          <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem;">
            <img id="profileIconLarge" src="assets/wormjbicon.png" style="width:64px; height:64px; border-radius:12px;" />
            <div style="flex:1;">
              <label>Username</label>
              <input id="profileUsername" class="ios-input" />
              <label>Full Name</label>
              <input id="profileFullname" class="ios-input" />
              <label style="margin-top:.5rem;">Display Mode</label>
              <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:0.5rem;">
                <label style="display:flex; gap:.4rem; align-items:center;"><input type="radio" name="profileMode" value="icon" id="modeIcon"> Icon Mode</label>
                <label style="display:flex; gap:.4rem; align-items:center;"><input type="radio" name="profileMode" value="button" id="modeButton"> Button Mode</label>
              </div>
              <label>Profile Icon URL</label>
              <input id="profileIconUrl" class="ios-input" />
            </div>
          </div>
          <div style="display:flex; gap:.5rem; justify-content:center; margin-top:.5rem;">
            <button class="ios-button" id="saveProfileBtn">Save</button>
            <button class="ios-button" id="closeProfileBtn">Close</button>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="ios-card">
        <h3>Settings</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Enable Logs</span>
            <label class="ios-switch">
              <input type="checkbox"><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item">
            <span>Auto-update</span>
            <label class="ios-switch">
              <input type="checkbox" checked><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item" onclick="promptDebugCode()">
            <span style="color: var(--ios-blue);">Debug</span>
          </div>
        </div>
      </div>
    </section>

    <section id="devsettings">
      <div class="ios-card">
        <h3>Developer Settings</h3>
        <p style="color: var(--ios-text-gray)">You’ve unlocked the dev menu.</p>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Verbose Logs</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Experimental Mode</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Force Apple Font (Web)</span>
            <label class="ios-switch">
              <input type="checkbox" id="forceAppleFontToggle"><span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: .75rem;">
          <button class="ios-button danger" onclick="clearAppData()">Clear App Data & Reload</button>
        </div>
      </div>
    </section>
  </main>

  <div id="alert" class="ios-alert">
    <h3>WormJB</h3>
    <p id="alert-text">Placeholder text</p>
    <button class="ios-button" onclick="hideAlert()">OK</button>
  </div>

  <!-- Background audio (loop) -->
  <audio id="bgAudio" preload="auto"></audio>

  <nav class="tabs" id="tab-bar">
    <div class="tab" data-tab="tweaks">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-5"/><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      <span>Tweaks</span>
    </div>
    <div class="tab active" data-tab="home">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/></svg>
      <span>Home</span>
    </div>
    <div class="tab" data-tab="settings">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 5.6a1.65 1.65 0 0 0 1-1.51V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span>Settings</span>
    </div>
  </nav>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('section');
    const tabBar = document.getElementById('tab-bar');

    function switchTab(target) {
      // Use fresh queries so dynamically added tabs (Dev) are handled
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.tab[data-tab="${target}"]`);
      if (tab) tab.classList.add('active');
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      const section = document.getElementById(target);
      if (section) section.classList.add('active');
    }

    tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

    function showAlert(msg) {
      const alertBox = document.getElementById('alert');
      document.getElementById('alert-text').textContent = msg;
      alertBox.style.display = 'block';
    }
    function hideAlert() {
      document.getElementById('alert').style.display = 'none';
    }

    function promptDebugCode() {
      const unlocked = localStorage.getItem('devUnlocked');
      if (unlocked === 'true') {
        showDevTab();
        switchTab('devsettings');
        return;
      }
      const code = prompt('Enter debug code:');
      if (code === 'brainworm') {
        localStorage.setItem('devUnlocked', 'true');
        showDevTab();
        switchTab('devsettings');
      }
    }

    function showDevTab() {
      if (!document.querySelector('.tab[data-tab=\"devsettings\"]')) {
        const devTab = document.createElement('div');
        devTab.className = 'tab';
        devTab.dataset.tab = 'devsettings';
        devTab.innerHTML = `
          <svg fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" viewBox=\"0 0 24 24\"><path d=\"M9 18l6-6-6-6\"/></svg>
          <span>Dev</span>`;
        devTab.addEventListener('click', () => switchTab('devsettings'));
        tabBar.appendChild(devTab);
      }
    }

    if (localStorage.getItem('devUnlocked') === 'true') {
      showDevTab();
    }

    // Font forcing (Apple-like font using Inter from web)
    const FORCE_FONT_KEY = 'forceAppleFont';

    function ensureInterLoaded() {
      if (document.getElementById('interFontLink')) return;
      const link = document.createElement('link');
      link.id = 'interFontLink';
      link.rel = 'stylesheet';
      link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap';
      document.head.appendChild(link);
    }

    function setForceAppleFont(enabled) {
      localStorage.setItem(FORCE_FONT_KEY, enabled ? 'true' : 'false');
      if (enabled) {
        ensureInterLoaded();
        document.documentElement.classList.add('force-apple-font');
      } else {
        document.documentElement.classList.remove('force-apple-font');
      }
      const cb = document.getElementById('forceAppleFontToggle');
      if (cb) cb.checked = !!enabled;
    }

    // Initialize state from storage
    if (localStorage.getItem(FORCE_FONT_KEY) === 'true') {
      setForceAppleFont(true);
    }

    // Wire toggle if present
    (function attachFontToggle() {
      const cb = document.getElementById('forceAppleFontToggle');
      if (!cb) return;
      cb.checked = localStorage.getItem(FORCE_FONT_KEY) === 'true';
      cb.addEventListener('change', (e) => setForceAppleFont(e.target.checked));
    })();

    // ---------- Tweaks rendering and persistence ----------
    const TWEAKS_KEY = 'wormjb_tweaks_v1';

    function defaultTweaks() {
      return [
        { id: 'tweak.wormjb.hookworm', name: 'Hookworm', description: 'The WormJB tweak loader', author: 'wormjb', version: '1.0', date: '2025-11-11', bg: '#f7b2f0', enabled: true },
        { id: 'tweak.pissrain.respring', name: 'Respring Support', description: 'Respring support for wormJB', author: 'Pissra1n tweak devs', version: '0.3.1', date: '2025-06-12', bg: '#b9f7b2', enabled: true },
        { id: 'app.sileo.demo', name: 'Sileo Demo', description: 'The installation of Sileo Demo is not yet supported through wormJB (this is a placeholder)', version: 'NOT SUPPORTED', author: 'Sileo Team', date: '1970-01-01', bg: '#f7b2b2', enabled: false }
      ];
    }

    function loadTweaks() {
      try {
        const raw = localStorage.getItem(TWEAKS_KEY);
        if (!raw) return defaultTweaks();
        return JSON.parse(raw);
      } catch (e) { return defaultTweaks(); }
    }

    function saveTweaks(tweaks) {
      localStorage.setItem(TWEAKS_KEY, JSON.stringify(tweaks));
    }

    function renderTweaks() {
      const container = document.getElementById('tweak-container');
      const tweaks = loadTweaks();
      container.innerHTML = '';
      tweaks.forEach((t, idx) => {
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.style.display = 'flex';
        item.style.flexDirection = 'row';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.background = t.bg || 'white';
        item.style.borderBottom = '1px solid var(--ios-border)';
        item.style.padding = '0.75rem';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.flex = '1';
        left.style.marginRight = '0.75rem';
        left.innerHTML = `
          <div style="display:flex; align-items:center; gap:.5rem;">
            <strong style="font-size:1rem">${escapeHtml(t.name)}</strong>
            <small style="color:#666">${escapeHtml(t.id)}</small>
          </div>
          <div style="color:#444; margin-top:0.25rem;">${escapeHtml(t.description)}</div>
          <div style="color:#666; font-size:0.85rem; margin-top:0.35rem;">By ${escapeHtml(t.author)} • v${escapeHtml(t.version)} • ${escapeHtml(t.date)}</div>
        `;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '0.5rem';

        const label = document.createElement('label');
        label.className = 'ios-switch';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!t.enabled;
        const span = document.createElement('span');
        span.className = 'slider';
        label.appendChild(checkbox);
        label.appendChild(span);

        checkbox.addEventListener('change', () => {
          const ts = loadTweaks();
          ts[idx].enabled = checkbox.checked;
          saveTweaks(ts);
        });

        right.appendChild(label);

        // If dev unlocked, show settings button
        if (localStorage.getItem('devUnlocked') === 'true') {
          const settingsBtn = document.createElement('button');
          settingsBtn.className = 'ios-button';
          settingsBtn.textContent = 'Settings';
          settingsBtn.style.padding = '0.4rem 0.6rem';
          settingsBtn.addEventListener('click', () => openTweakEditor(idx));
          right.appendChild(settingsBtn);
        }

        item.appendChild(left);
        item.appendChild(right);
        container.appendChild(item);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Tweak editor modal
    let currentEditIndex = null;
    function openTweakEditor(idx) {
      const tweaks = loadTweaks();
      const t = tweaks[idx];
      if (!t) return;
      currentEditIndex = idx;
      document.getElementById('tweakName').value = t.name || '';
      document.getElementById('tweakId').value = t.id || '';
      document.getElementById('tweakDesc').value = t.description || '';
      document.getElementById('tweakAuthor').value = t.author || '';
      document.getElementById('tweakVersion').value = t.version || '';
      document.getElementById('tweakDate').value = t.date || '';
      document.getElementById('tweakBg').value = t.bg || '';
      const modal = document.getElementById('tweakModal');
      modal.style.display = 'block';
    }

    document.getElementById('saveTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      if (currentEditIndex === null) return hideAlert();
      tweaks[currentEditIndex] = {
        id: document.getElementById('tweakId').value,
        name: document.getElementById('tweakName').value,
        description: document.getElementById('tweakDesc').value,
        author: document.getElementById('tweakAuthor').value,
        version: document.getElementById('tweakVersion').value,
        date: document.getElementById('tweakDate').value,
        bg: document.getElementById('tweakBg').value,
        enabled: tweaks[currentEditIndex].enabled
      };
      saveTweaks(tweaks);
      hideAlert();
      renderTweaks();
    });

    // Override hideAlert to hide modal too
    const originalHide = hideAlert;
    function hideAlert() {
      const modal = document.getElementById('tweakModal');
      if (modal) modal.style.display = 'none';
      const alertBox = document.getElementById('alert');
      if (alertBox) alertBox.style.display = 'none';
    }

    // Show alert remains same but ensure modal can be reused
    // render initially
    renderTweaks();

    // ---------- Profile management and Add Tweak ----------
    const PROFILE_KEY = 'wormjb_profile_v1';

    function loadProfile() {
      try { return JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}'); } catch (e) { return {}; }
    }

    function saveProfile(p) { localStorage.setItem(PROFILE_KEY, JSON.stringify(p || {})); }

    function applyProfileToHeader() {
      const p = loadProfile();
      const name = p.username || 'User Name';
      const full = p.fullname || '';
      const icon = p.icon || 'assets/wormjbicon.png';
      const mode = p.displayMode || 'icon';

      // Header username (left-side). Only shown in Icon Mode; hidden in Button Mode.
      const headerUsernameEl = document.getElementById('headerUsername');
      if (headerUsernameEl) headerUsernameEl.textContent = name;

      // Profile icon elements
      const img = document.getElementById('profileIcon');
      const imgLarge = document.getElementById('profileIconLarge');
      if (img) img.src = icon;
      if (imgLarge) imgLarge.src = icon;

      // Use full name as tooltip on the icon/button
      const wrap = document.getElementById('headerProfileWrap');
      if (wrap) wrap.title = full || name;

      // Set the button label inside the profile button (used in Button Mode)
      const btnLabel = document.getElementById('profileBtnLabel');
      if (btnLabel) btnLabel.textContent = name;

      // Reflect mode in header rendering
      renderProfileDisplayMode(mode);

      // populate profile fields in profile panel
      const inputUser = document.getElementById('profileUsername');
      const fn = document.getElementById('profileFullname');
      const iu = document.getElementById('profileIconUrl');
      const modeIcon = document.getElementById('modeIcon');
      const modeButton = document.getElementById('modeButton');
      if (inputUser) inputUser.value = p.username || '';
      if (fn) fn.value = p.fullname || '';
      if (iu) iu.value = p.icon || '';
      if (modeIcon) modeIcon.checked = (mode === 'icon');
      if (modeButton) modeButton.checked = (mode === 'button');
    }

    function renderProfileDisplayMode(mode) {
      const headerUsernameEl = document.getElementById('headerUsername');
      const profileBtn = document.getElementById('profileBtn');
      const profileIcon = document.getElementById('profileIcon');
      const profileBtnLabel = document.getElementById('profileBtnLabel');
      if (!profileBtn || !profileIcon) return;

      if (mode === 'button') {
        // Button Mode: hide left username, style the profile as a button with icon + username inside
        if (headerUsernameEl) headerUsernameEl.style.display = 'none';
        profileBtn.classList.add('ios-button');
        profileBtn.style.padding = '0.3rem 0.6rem';
        profileBtnLabel.style.display = 'inline';
        // ensure aria/tooltip shows fullname via parent title
        profileBtn.setAttribute('aria-label', profileBtnLabel.textContent || 'Profile');
      } else {
        // Icon Mode: show username to the left, render the icon as an unstyled icon button
        if (headerUsernameEl) headerUsernameEl.style.display = 'inline-block';
        profileBtn.classList.remove('ios-button');
        profileBtn.style.padding = '0';
        profileBtnLabel.style.display = 'none';
        profileBtn.style.background = 'transparent';
        profileBtn.style.border = 'none';
      }

      // Ensure the icon image remains clickable but visually appropriate
      profileIcon.style.width = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.height = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.borderRadius = '4px';
    }

    document.getElementById('profileBtn').addEventListener('click', () => {
      // show profile panel (hide others)
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById('profilePanel').style.display = 'block';
      // ensure header buttons aren't considered active tab
      applyProfileToHeader();
    });

    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      document.getElementById('profilePanel').style.display = 'none';
      // re-open home
      switchTab('home');
    });

    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      const mode = (document.getElementById('modeButton') && document.getElementById('modeButton').checked) ? 'button' : 'icon';
      const p = {
        username: document.getElementById('profileUsername').value,
        fullname: document.getElementById('profileFullname').value,
        icon: document.getElementById('profileIconUrl').value,
        displayMode: mode
      };
      saveProfile(p);
      applyProfileToHeader();
      showAlert('Profile saved');
    });

    // Live preview when switching display mode in profile panel
    const modeIconRadio = document.getElementById('modeIcon');
    const modeButtonRadio = document.getElementById('modeButton');
    if (modeIconRadio) modeIconRadio.addEventListener('change', () => { if (modeIconRadio.checked) renderProfileDisplayMode('icon'); });
    if (modeButtonRadio) modeButtonRadio.addEventListener('change', () => { if (modeButtonRadio.checked) renderProfileDisplayMode('button'); });

    // Show Add Tweak button when devUnlocked
    function updateDevUI() {
      const addBtn = document.getElementById('addTweakBtn');
      if (!addBtn) return;
      if (localStorage.getItem('devUnlocked') === 'true') {
        addBtn.style.display = 'inline-block';
      } else {
        addBtn.style.display = 'none';
      }
    }

    document.getElementById('addTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      const newT = { id: 'tweak.' + Date.now(), name: 'New Tweak', description: '', author: '', version: '0.1', date: new Date().toISOString().slice(0,10), bg: '#ffffff', enabled: false };
      tweaks.unshift(newT);
      saveTweaks(tweaks);
      renderTweaks();
      // open editor for the new tweak (index 0)
      openTweakEditor(0);
    });

    // apply profile & dev UI initially
    applyProfileToHeader();
    updateDevUI();

    async function clearAppData() {
      const confirmClear = confirm('This will clear all saved data for this app (settings, caches, cookies) and reload. Dev menu will be locked again. Continue?');
      if (!confirmClear) return;

      try {
        // Ensure dev menu will be locked on next load
        try { localStorage.removeItem('devUnlocked'); } catch (e) {}

        // Local/session storage
        try { localStorage.clear(); } catch (e) {}
        try { sessionStorage.clear(); } catch (e) {}

        // IndexedDB (best-effort)
        try {
          if ('databases' in indexedDB && typeof indexedDB.databases === 'function') {
            const dbs = await indexedDB.databases();
            for (const db of dbs) {
              if (db && db.name) {
                try { indexedDB.deleteDatabase(db.name); } catch (e) {}
              }
            }
          }
        } catch (e) {}

        // Cache Storage
        try {
          if (window.caches && caches.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        } catch (e) {}

        // Service Workers
        try {
          if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
        } catch (e) {}

        // Cookies (best-effort for this origin)
        try {
          const cookies = document.cookie ? document.cookie.split(';') : [];
          for (const c of cookies) {
            const eqPos = c.indexOf('=');
            const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
            const expires = 'Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = `${name}=;expires=${expires};path=/`;
            // Attempt domain-scoped delete as well
            const host = location.hostname;
            document.cookie = `${name}=;expires=${expires};path=/;domain=${host}`;
            if (!host.startsWith('.')) {
              document.cookie = `${name}=;expires=${expires};path=/;domain=.${host}`;
            }
          }
        } catch (e) {}
      } finally {
        // Reload the page to reflect cleared state
        location.reload();
      }
    }

    // ---------- wormJB action helpers ----------
    function setStatus(msg) {
      const el = document.getElementById('statusText');
      if (el) el.textContent = 'Status: ' + msg;
    }

    function buildReJailbreakCommands(clean) {
      const cmds = [];
      if (clean) cmds.push('wormjb revert || true');
      cmds.push('cd ~/Documents');
      cmds.push('rm -rf wormJB');
      cmds.push('git clone https://github.com/wheatbread2056/wormJB');
      cmds.push('cd wormJB');
      cmds.push('sh jb/main.sh');
      return cmds;
    }

    function openInAShell(commandsArray) {
      // Combine commands using && so failure stops chain
      const joined = commandsArray.join(' && ');
      // URL scheme guess for A-Shell. If different, adjust run?cmd= parameter.
      const url = 'ashell://run?command=' + encodeURIComponent(joined);
      // Attempt navigation
      setStatus('Launching A-Shell...');
      // Copy to clipboard for fallback/paste
      try {
        navigator.clipboard.writeText(joined);
      } catch (e) {
        // ignore
      }
      // Navigate
      window.location.href = url;
      // Provide alert info
      showAlert('Attempted to launch A-Shell. If it did not open, paste commands manually (already copied).');
    }

    function wireButtons() {
      const reBtn = document.getElementById('reJBBtn');
      const cleanToggle = document.getElementById('cleanReJB');
      const removeBtn = document.getElementById('removeJBBtn');
      const sideStoreBtn = document.getElementById('installSideStoreBtn');
      const repoBtn = document.getElementById('openRepoBtn');
      const showScriptBtn = document.getElementById('showScriptBtn');
      const mysteryBtn = document.getElementById('mysteryBtn');

      if (reBtn) reBtn.addEventListener('click', () => {
        const cmds = buildReJailbreakCommands(cleanToggle && cleanToggle.checked);
        setStatus('couldnt figure out how to open commands in a shell so just do it yourself.');
        showAlert("I apologize");
      });
      if (removeBtn) removeBtn.addEventListener('click', () => {
        setStatus('ts doesnt work');
        showAlert("I apologize");
      });
      if (sideStoreBtn) sideStoreBtn.addEventListener('click', () => {
        setStatus('Opening SideStore site...');
        window.open('https://sidestore.io#get-started', '_blank');
      });
      if (repoBtn) repoBtn.addEventListener('click', () => {
        setStatus('Opening repo...');
        window.open('https://github.com/wheatbread2056/wormJB', '_blank');
      });
      if (showScriptBtn) showScriptBtn.addEventListener('click', () => {
        window.open('https://github.com/wheatbread2056/wormJB/blob/main/jb/main.sh', '_blank');
      });
      if (mysteryBtn) mysteryBtn.addEventListener('click', () => {
        showAlert('Absolutely nothing happened.');
      });
    }
    wireButtons();

    // ---------- audio loop support ----------
    (function setupLoopingAudio() {
      const audio = document.getElementById('bgAudio');
      const toggle = document.getElementById('audioToggleBtn');
      const state = document.getElementById('audioState');
      if (!audio || !toggle || !state) return;

      // handle space in filename
      const src = encodeURI('assets/test 104.mp3');
      audio.src = src;
      // Looping is enabled by default (user requested)
      audio.loop = true;
      audio.volume = 0.8;

      function updateUI() {
        // show whether looping is enabled and whether playback is active
        state.textContent = audio.loop ? (audio.paused ? 'on (paused)' : 'on') : 'off';
        toggle.textContent = audio.paused ? 'Play Looping Audio' : 'Pause Audio';
      }

      // Try immediate play; if blocked, start playback on first user interaction
      audio.play().then(() => {
        updateUI();
      }).catch(() => {
        // Autoplay blocked; set UI and wait for first user gesture
        updateUI();
        const startOnGesture = () => {
          audio.play().then(() => updateUI()).catch(() => {});
        };
        // Use pointerdown to catch touch/click quickly; once-only listener
        document.addEventListener('pointerdown', startOnGesture, { once: true, capture: true });
        // also listen for keydown as a fallback
        document.addEventListener('keydown', startOnGesture, { once: true, capture: true });
      });

      toggle.addEventListener('click', () => {
        if (audio.paused) {
          audio.play().then(() => updateUI()).catch(() => {
            showAlert('Playback blocked by browser. Tap anywhere to start audio.');
          });
        } else {
          audio.pause();
          updateUI();
        }
      });

      // initialize UI
      updateUI();
    })();
  </script>
</body>
</html>
