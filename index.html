<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WormJB</title>
  <script>
    const APP_VERSION = 'v1.0.rc2';
  </script>
  <style>
    :root {
      --ios-blue: #007aff;
      --ios-gray: #f2f2f7;
      --ios-border: #c6c6c8;
      --ios-bg: #ffffff;
      --ios-text-gray: #555;
      --app-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --app-mono-font: 'SFMono-Regular', 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      --glass-surface: rgba(255, 255, 255, 0.78);
      --glass-border: rgba(255, 255, 255, 0.45);
      --glass-shadow: 0 24px 45px rgba(15, 23, 42, 0.18);
    }
    html.dark {
      --glass-surface: rgba(15, 18, 24, 0.78);
      --glass-border: rgba(148, 163, 184, 0.25);
      --glass-shadow: 0 28px 55px rgba(0, 0, 0, 0.65);
    }
    /* Dark variables are applied via early bootstrap/applyTheme; avoid CSS overrides leaking into light mode */
    html, body {
      margin: 0; padding: 0;
      font-family: var(--app-font-family);
      background: var(--ios-bg);
      color: #000;
      height: 100%;
      overflow: hidden;
      scroll-behavior: smooth;
    }
    code, pre, .mono-block {
      font-family: var(--app-mono-font) !important;
      letter-spacing: 0.01em;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: calc(56px + env(safe-area-inset-top, 0px));
      padding-top: env(safe-area-inset-top, 0px);
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 1.2rem;
      border-bottom: 1px solid var(--ios-border);
      background: white; z-index: 10;
    }
    .version {
      position: fixed; top: calc(56px + env(safe-area-inset-top, 0px)); width: 100%; text-align: center;
      font-size: 0.8rem; color: var(--ios-text-gray); background: white; padding: 0.3rem 0;
      z-index: 9;
    }
    main {
      position: absolute; top: calc(84px + env(safe-area-inset-top, 0px)); bottom: 60px; left: 0; right: 0;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      background: var(--ios-bg);
      padding: 1rem; box-sizing: border-box;
    }
  section { display: none; }
  section.active { display: block; }
  section.section-enter { animation: sectionFadeUp 0.5s cubic-bezier(0.22,0.61,0.36,1); }

  @keyframes sectionFadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

    .ios-card {
      background: white; border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 1rem; margin: 1rem 0;
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), box-shadow 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .ios-card:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(0,0,0,0.09); }
    .ios-list {
      background: white; border-radius: 12px;
      overflow: hidden; border: 1px solid var(--ios-border);
    }
    .ios-list-item {
      padding: 1rem; border-bottom: 1px solid var(--ios-border);
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1rem;
      transition: background 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
    }
    .ios-list-item:hover { background: rgba(0,0,0,0.02); }
    .ios-list-item:active { transform: scale(0.997); }
    .animate-list-item {
      opacity: 0; transform: translateY(14px);
      animation: listItemFloat 0.45s cubic-bezier(0.22,0.61,0.36,1) forwards;
      animation-delay: calc(var(--stagger-index, 0) * 60ms);
    }
    @keyframes listItemFloat {
      from { opacity: 0; transform: translateY(14px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .ios-list-item:last-child { border-bottom: none; }
    .ios-button {
      background: var(--ios-blue); color: white; border: none;
      border-radius: 12px; font-size: 1rem; padding: 0.7rem 1.5rem;
      font-weight: 500; cursor: pointer; transition: opacity 0.2s, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }
  .ios-button:hover { transform: translateY(-1px); box-shadow: 0 12px 18px rgba(0,0,0,0.12); }
    .ios-button:active { opacity: 0.7; transform: scale(0.97); }
    .ios-button.danger { background: #ff3b30; }
    .ios-input {
      border: 1px solid var(--ios-border);
      border-radius: 12px; padding: 0.6rem 1rem;
      font-size: 1rem; width: 100%;
      background: var(--ios-gray); box-sizing: border-box;
      margin: 0.5rem 0;
    }
    .ios-switch { position: relative; width: 50px; height: 28px; }
    .ios-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; border-radius: 34px; transition: background 0.25s ease;
    }
    .slider:before {
      position: absolute; content: "";
      height: 22px; width: 22px; left: 3px; bottom: 3px;
      background-color: white; border-radius: 50%; transition: transform 0.25s ease;
    }
    .ios-switch input:checked + .slider { background-color: var(--ios-blue); }
    .ios-switch input:checked + .slider:before { transform: translateX(22px); }
    .ios-alert {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.94);
      background: white; border-radius: 14px; padding: 1.2rem;
      box-shadow: 0 18px 32px rgba(0,0,0,0.25);
      text-align: center; width: 80%; max-width: 320px;
      opacity: 0; visibility: hidden; pointer-events: none;
      transition: opacity 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
    }
    .ios-alert.visible {
      opacity: 1; visibility: visible; pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    .ios-alert.closing {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.9);
      pointer-events: none;
    }
    /* Dark mode for alerts/modals */
    html.dark .ios-alert { background: #111315; color: #e5e7eb; border: 1px solid var(--ios-border); }

    /* Scrollable tweak edit modal cleanup */
  #tweakModal { max-height: 80vh; width: 92vw; max-width: 420px; padding: 0; overflow: hidden; }
    #tweakModal h3 { margin: 1rem 1rem 0.25rem 1rem; }
    #tweakModalBody { text-align: left; margin: 0; padding: 0 1rem 0.5rem 1rem; max-height: 58vh; overflow-y: auto; }
    #tweakModal .modal-actions { display:flex; gap:.5rem; margin: .75rem 1rem 1rem; justify-content:center; flex-wrap:wrap; }

    /* System info refresh */
    .system-info-card h3 { margin-bottom: 0.4rem; }
    .card-title-row { display:flex; justify-content:space-between; align-items:center; gap:0.75rem; }
    .sys-mode-pill {
      display:inline-flex; align-items:center; gap:0.35rem;
      padding:0.35rem 0.85rem; border-radius:999px;
      background: rgba(0,122,255,0.12); color: var(--ios-blue);
      font-size:0.85rem; font-weight:600;
      border:1px solid rgba(0,122,255,0.15);
      text-transform:uppercase; letter-spacing:0.02em;
    }
    .sys-mode-pill.testing { background: rgba(255,149,0,0.16); color:#c2410c; border-color: rgba(255,149,0,0.25); }
    .sys-info-grid {
      display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:0.75rem; margin-top:0.75rem;
    }
    .sys-info-item {
      background: #f8f8fb;
      border-radius: 14px;
      padding: 0.85rem;
      border: 1px solid rgba(0,0,0,0.03);
    }
    html.dark .sys-info-item { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.05); }
    .sys-info-label { font-size:0.8rem; color: var(--ios-text-gray); text-transform:uppercase; letter-spacing:0.05em; }
    .sys-info-value { font-size:1.3rem; font-weight:600; margin-top:0.2rem; }
    .sys-testing-panel {
      margin-top:1.25rem;
      border-radius:16px;
      padding:1.1rem;
      background: linear-gradient(135deg, rgba(255,149,0,0.18), rgba(255,94,58,0.25));
      color:#431407;
      border:1px solid rgba(249,115,22,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
    }
    html.dark .sys-testing-panel {
      color:#ffedd5;
      border-color: rgba(251,146,60,0.4);
      background: linear-gradient(135deg, rgba(251,146,60,0.18), rgba(234,88,12,0.32));
    }
    .sys-testing-heading { display:flex; align-items:center; gap:0.6rem; margin-bottom:0.4rem; }
    .testing-pill {
      font-size:0.78rem; font-weight:600; letter-spacing:0.08em;
      text-transform:uppercase; color:#431407;
      background: rgba(255,255,255,0.65);
      padding:0.2rem 0.75rem; border-radius:999px;
    }
    html.dark .testing-pill { color:#fed7aa; background: rgba(0,0,0,0.35); }
    .testing-dot { width:8px; height:8px; border-radius:999px; background:#f97316; animation:pulse 1.8s ease infinite; }
    @keyframes pulse {
      0% { transform:scale(1); opacity:1; }
      50% { transform:scale(1.6); opacity:0.4; }
      100% { transform:scale(1); opacity:1; }
    }
    .sys-testing-panel p { margin:0; line-height:1.4; }
    .sys-testing-panel ul {
      list-style:none; padding:0; margin:0.75rem 0 0;
      display:flex; flex-direction:column; gap:0.35rem;
    }
    .sys-testing-panel li { display:flex; gap:0.4rem; align-items:flex-start; font-size:0.92rem; }
    .sys-testing-panel li::before {
      content:"•"; color:#f97316; font-weight:700; line-height:1;
    }
    html.dark .sys-testing-panel li::before { color:#fdba74; }

  /* Status colors */
    .status-row { display:flex; align-items:center; justify-content:space-between; padding: .5rem 1rem; border-top: 1px solid var(--ios-border); }
    .status-row:first-child { border-top: none; }
    .status-pill { font-weight:600; }
    .status-red { color: #ef4444; }
    .status-yellow { color: #eab308; }
    .status-green { color: #22c55e; }
    .status-magenta { color: #d946ef; }
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; border-top: 1px solid var(--ios-border);
      background: white; height: 60px; z-index: 10;
      backdrop-filter: blur(12px);
      isolation: isolate;
      overflow: visible;
    }
    .tab {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--ios-text-gray); font-size: 0.7rem; cursor: pointer;
      user-select: none;
      position: relative;
      transition: color 0.3s ease;
    }
    .tab:active { transform: scale(0.96); }

    /* Add consistent gap between icon and label and allow top alignment when tabs are tall */
    .tab { gap: 6px; }
    .tabs.tall .tab { justify-content: flex-start; padding-top: 8px; }
  .tab.active { color: var(--ios-blue); }
  svg { width: 22px; height: 22px; margin-bottom: 2px; }

      /* App enter animations (cards, sections) */
      body.ready .ios-card {
        animation: cardPop 0.55s cubic-bezier(0.34,1.56,0.64,1) both;
        animation-delay: calc(var(--card-index, 0) * 80ms);
      }
      @keyframes cardPop {
        0% { opacity: 0; transform: translateY(22px) scale(0.98); }
        60% { opacity: 1; transform: translateY(-2px) scale(1.01); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }
      body.reduced-motion .ios-card {
        animation: none !important;
      }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
        html, body { scroll-behavior: auto; }
      }

    /* Tweak list layout stability */
    .tweak-left {
      display: flex; flex-direction: column; flex: 1 1 auto; min-width: 0;
    }
  .tweak-title-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; min-width:0; width:100%; }
  .tweak-name { font-size:1rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1 1 auto; min-width:0; }
  .tweak-desc { color: var(--ios-text-gray); margin-top:0.25rem; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; }
    .tweak-meta { color: var(--ios-text-gray); font-size:0.85rem; margin-top:0.35rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Header username color uses variable for proper dark/light contrast */
    #headerUsername { color: var(--ios-text-gray); }
    .tweak-right { display:flex; align-items:center; gap:.5rem; flex: 0 0 auto; }
  .tweak-id-floating {
    position:absolute;
    top:0.55rem;
    right:0.75rem;
    font-size:0.85rem;
    color: var(--ios-text-gray);
    white-space:nowrap;
    max-width:45%;
    text-overflow:ellipsis;
    overflow:hidden;
    text-align:right;
  }

  /* Version pill next to title */
  .version-pill { border: 1px solid var(--ios-border); color: var(--ios-text-gray); border-radius: 9999px; padding: 0.05rem 0.5rem; font-size: 0.8rem; font-weight: 500; }
  .ios-button.magenta { background: #d946ef; }
  .tabs.tall { height: 80px; }
  /* When tabs are tall, give main extra bottom spacing; applied via JS */

    /* When forcing Apple-like font (Inter) */
    html.force-apple-font {
      --app-font-family: 'Inter', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    /* Profile panel refresh */
    .profile-card { padding:0; overflow:hidden; }
    .profile-hero {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color:#fff;
      padding:1.3rem;
      display:flex;
      align-items:center;
      gap:1rem;
    }
    html.dark .profile-hero { background: linear-gradient(135deg, #4338ca, #7c3aed); }
    .profile-avatar-shell { display:flex; flex-direction:column; gap:0.5rem; align-items:center; }
    .profile-avatar-shell img { box-shadow:0 10px 20px rgba(15,23,42,0.35); }
    .profile-hero-eyebrow { text-transform:uppercase; font-size:0.75rem; letter-spacing:0.15em; opacity:0.7; margin:0; }
    .profile-hero h2 { margin:0.15rem 0 0.35rem; font-size:1.5rem; }
    .profile-hero p { margin:0; line-height:1.4; opacity:0.88; }
    .profile-form { padding:1.1rem 1.25rem 1.25rem; display:flex; flex-direction:column; gap:1rem; }
    .profile-field { display:flex; flex-direction:column; gap:0.4rem; }
    .profile-field label { font-size:0.85rem; font-weight:600; color: var(--ios-text-gray); text-transform:uppercase; letter-spacing:0.08em; }
    .profile-field small { color: var(--ios-text-gray); }
    .profile-mode-toggle { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .profile-mode-pill {
      border:1px solid var(--ios-border);
      border-radius:999px;
      padding:0.35rem 0.9rem;
      display:flex; align-items:center; gap:0.35rem;
      font-weight:600; cursor:pointer;
      transition:border 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .profile-mode-pill input { display:none; }
    .profile-mode-pill.active { background: rgba(0,122,255,0.12); border-color: rgba(0,122,255,0.3); color: var(--ios-blue); }
    .profile-actions { display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; }
    .profile-upload input[type="file"] { padding:0.5rem; background:#fff; border-radius:12px; border:1px dashed rgba(0,0,0,0.15); }
    html.dark .profile-upload input[type="file"] { background:#111315; border-color: rgba(255,255,255,0.2); color:#e5e7eb; }

    .credits-card { overflow:hidden; }
    .credits-header { margin-bottom:0.75rem; }
    .credits-subtitle { color: var(--ios-text-gray); margin:0.2rem 0 0; }
    .credits-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:0.75rem; }
    .credit-item {
      padding:0.85rem;
      border-radius:14px;
      background: #f5f5f7;
      border:1px solid rgba(0,0,0,0.05);
      display:flex; flex-direction:column; gap:0.2rem;
    }
    .credit-label { font-size:0.78rem; text-transform:uppercase; letter-spacing:0.12em; color: var(--ios-text-gray); }
    .credit-value { font-weight:600; }
    html.dark .credit-item { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }

    /* Glass mode */
    html.glass-mode body {
      background: radial-gradient(circle at top, rgba(99,102,241,0.25), transparent 60%),
                  radial-gradient(circle at 30% 40%, rgba(236,72,153,0.18), transparent 55%),
                  var(--ios-bg);
    }
    html.glass-mode .ios-card,
    html.glass-mode .ios-list,
    html.glass-mode header,
    html.glass-mode .tabs,
    html.glass-mode .ios-alert {
      background: var(--glass-surface) !important;
      border-color: var(--glass-border) !important;
      box-shadow: var(--glass-shadow);
      backdrop-filter: saturate(160%) blur(22px);
      -webkit-backdrop-filter: saturate(160%) blur(22px);
    }
    html.glass-mode .ios-card,
    html.glass-mode .ios-list { border:1px solid var(--glass-border); }
  html.glass-mode .ios-list-item { background: transparent; border-color: var(--glass-border); }
  html.glass-mode .profile-hero { background: linear-gradient(135deg, rgba(99,102,241,0.45), rgba(139,92,246,0.3)); box-shadow: var(--glass-shadow); }
  html.dark.glass-mode .profile-hero { background: linear-gradient(135deg, rgba(67,56,202,0.65), rgba(124,58,237,0.5)); }
  html.glass-mode .sys-info-item,
  html.glass-mode .credit-item,
  html.glass-mode .sys-testing-panel,
  html.glass-mode .profile-upload input[type="file"] {
    background: var(--glass-surface);
    border-color: var(--glass-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
    backdrop-filter: saturate(160%) blur(22px);
    -webkit-backdrop-filter: saturate(160%) blur(22px);
  }
  html.glass-mode .credit-item,
  html.glass-mode .sys-info-item { color: inherit; }
  html.glass-mode .sys-testing-panel { color:#1f2937; }
  html.dark.glass-mode .sys-testing-panel { color:#e5e7eb; }
    html.glass-mode .tabs {
      border-top: none;
      border-radius:32px;
      width:calc(100% - 2rem);
      left:50%;
      transform:translateX(-50%);
      right:auto;
      bottom:18px;
      box-shadow: none;
      background: transparent !important;
    }
    html.glass-mode .tabs::before {
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background: var(--glass-surface);
      border:1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      backdrop-filter: saturate(160%) blur(22px);
      -webkit-backdrop-filter: saturate(160%) blur(22px);
      z-index:-1;
    }
  html.glass-mode .tabs.tall { bottom:32px; height:60px; }
  html.glass-mode .tabs.tall .tab { justify-content:center; padding-top:0; }
  html.glass-mode main { background: transparent; }
  </style>
  <!-- Early theme bootstrap to avoid flash and ensure variables are set before paint -->
  <script>
    (function(){
      try {
        var mode = localStorage.getItem('themeMode') || 'system';
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var dark = (mode === 'dark') || (mode === 'system' && prefersDark);
        if (dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
        var customBg = localStorage.getItem('customBg') || '';
        var bg = customBg || (dark ? '#0b0b0d' : '#ffffff');
        var border = dark ? '#2a2d34' : '#c6c6c8';
        var textGray = dark ? '#a1a1aa' : '#555';
        document.documentElement.style.setProperty('--ios-bg', bg);
        document.documentElement.style.setProperty('--ios-border', border);
        document.documentElement.style.setProperty('--ios-text-gray', textGray);
      } catch(e) {}
    })();
  </script>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between; padding:0 1rem;">
    <div style="display:flex; align-items:center; gap:.5rem;">
      <span style="font-weight:600; font-size:1.2rem;">WormJB</span>
  <span id="appVersion" class="version-pill">—</span>
    </div>
    <div id="headerProfileWrap" style="display:flex; align-items:center; gap:.5rem;">
  <span id="headerUsername" style="color: var(--ios-text-gray); font-size:0.95rem;">WormJB User</span>
      <!-- Profile button/icon. In Icon Mode this will be shown as an unstyled icon button; in Button Mode it will have .ios-button styling and include the username label inside the button -->
      <button id="profileBtn" class="ios-button" style="padding:0.3rem 0.6rem; display:flex; align-items:center; gap:.5rem;">
        <img id="profileIcon" src="assets/wormjbicon.png" alt="icon" style="width:20px; height:20px; border-radius:4px;" />
        <span id="profileBtnLabel" style="font-size:0.9rem;">Profile</span>
      </button>
    </div>
  </header>
  

  <main>
    <section id="home" class="active">
      <div class="ios-card">
  <h3 id="welcomeTitle">Welcome, WormJB User</h3>

        <!-- Compact action buttons (no extra titles) -->
        <div class="ios-list" style="margin-top:0.5rem;">
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button danger" id="removeJBBtn" style="width:100%;">Remove Jailbreak</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="installSideStoreBtn" style="width:100%;">Install SideStore</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="openRepoBtn" style="width:100%;">Open GitHub Repo</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="showScriptBtn" style="width:100%;">Show Script</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="openTerminalBtn" style="width:100%;">Open Terminal (A-Shell)</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="mysteryBtn" style="width:100%;">Do Nothing</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="copyHashBtn" style="width:100%;">Copy WormJB Device Hash</button>
          </div>
        </div>
      </div>
      <div class="ios-card">
        <h3>Status Report</h3>
        <div class="ios-list">
          <div class="status-row"><span>Sandboxed</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>PPL</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>SPTM</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>Environment</span><span class="status-pill status-yellow">Semi-Rootless</span></div>
          <div class="status-row"><span>SEP</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>WormJB</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>Root Access</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>Made with</span><span class="status-pill status-magenta">love</span></div>
        </div>
      </div>
    </section>

    <section id="tweaks">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; gap:.5rem;">
  <button id="browserBtn" class="ios-button">Browser</button>
  <button id="addTweakBtn" class="ios-button">Add Tweak</button>
      </div>
      <div id="tweak-container" class="ios-list" style="padding:0;">
        <!-- Tweaks will be rendered here by JS -->
      </div>

      <!-- Tweak edit modal (dev only) -->
  <div id="tweakModal" class="ios-alert">
        <h3>Edit Tweak</h3>
        <div id="tweakModalBody" style="text-align:left; margin-top:.5rem;">
          <label>Name</label>
          <input id="tweakName" class="ios-input" />
          <label>ID</label>
          <input id="tweakId" class="ios-input" />
          <label>Description</label>
          <input id="tweakDesc" class="ios-input" />
          <label>Author</label>
          <input id="tweakAuthor" class="ios-input" />
          <label>Version</label>
          <input id="tweakVersion" class="ios-input" />
          <label>Date</label>
          <input id="tweakDate" class="ios-input" />
          <label>Background Color</label>
          <input id="tweakBg" class="ios-input" placeholder="#ffffff" />
          <hr style="border:none; border-top:1px solid var(--ios-border); margin:.75rem 0;" />
          <label>onEnable (JS code)</label>
          <textarea id="tweakOnEnable" class="ios-input mono-block" style="min-height:72px"></textarea>
          <label>Enable Confirmation Prompt</label>
          <input id="tweakEnablePrompt" class="ios-input" placeholder="Are you sure you want to enable?" />
          <label>Disable Confirmation Prompt</label>
          <input id="tweakDisablePrompt" class="ios-input" placeholder="Are you sure you want to disable?" />
        </div>
        <div class="modal-actions" style="display:flex; gap:.5rem; margin-top: .75rem; justify-content:center; flex-wrap:wrap;">
          <button class="ios-button" id="saveTweakBtn">Save</button>
          <button class="ios-button danger" id="deleteTweakBtn">Delete</button>
          <button class="ios-button" onclick="closeTweakModal()">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Tweak Browser page -->
    <!-- Repos list page -->
  <section id="tweakBrowser">
      <div class="ios-card">
        <h3>Repos</h3>
        <div class="ios-list" id="reposList" style="padding:0;"></div>
        <div style="display:flex; justify-content:center; gap:.5rem; margin-top:.75rem; flex-wrap:wrap;">
          <button class="ios-button" id="addRepoBtn">Add Repo</button>
          <button class="ios-button" id="backFromBrowserBtn">Back</button>
        </div>
      </div>
    </section>

    <!-- Repo items view -->
  <section id="repoItems">
      <div class="ios-card">
        <h3 id="repoTitle">Repo</h3>
        <div class="ios-list" style="padding:0;">
          <div class="ios-list-item" style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button class="ios-button" id="repoFilterAll" style="padding:.4rem .9rem;">All</button>
            <button class="ios-button" id="repoFilterTweaks" style="padding:.4rem .9rem;">Tweaks</button>
            <button class="ios-button" id="repoFilterApps" style="padding:.4rem .9rem;">Apps</button>
          </div>
        </div>
        <div class="ios-list" id="repoItemsList" style="padding:0; margin-top:.5rem;"></div>
        <div style="display:flex; justify-content:center; gap:.5rem; margin-top:.75rem; flex-wrap:wrap;">
          <button class="ios-button" id="backToReposBtn">Repos</button>
        </div>
      </div>
    </section>

    <!-- Add Repo Modal -->
  <div id="addRepoModal" class="ios-alert" style="max-width:420px; width:92vw;">
      <h3>Add Repo</h3>
      <div style="text-align:left; margin-top:.5rem;">
        <label>Name</label>
        <input id="newRepoName" class="ios-input" placeholder="My Repo" />
        <label>JSON URL (optional)</label>
        <input id="newRepoUrl" class="ios-input" placeholder="https://example.com/repo.json" />
        <label>Or Paste JSON (array of items)</label>
  <textarea id="newRepoJson" class="ios-input mono-block" style="min-height:90px" placeholder='[{"type":"tweak","name":"Foo","desc":"...","ver":"1.0","date":"2025-01-01","author":"me","bg":"#fff"}]'></textarea>
        <small style="color:var(--ios-text-gray); display:block; margin-top:.5rem;">Each item needs: type (tweak|app), name, desc, ver, date (YYYY-MM-DD), author, bg (color). URL fetch overrides pasted JSON if provided.</small>
      </div>
      <div style="display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; justify-content:center;">
        <button class="ios-button" id="confirmAddRepoBtn">Add</button>
        <button class="ios-button" id="cancelAddRepoBtn">Cancel</button>
      </div>
    </div>

    <!-- Profile page (hidden until opened) -->
    <section id="profile">
      <div class="ios-card profile-card">
        <div class="profile-hero">
          <div class="profile-avatar-shell">
            <img id="profileIconLarge" src="assets/wormjbicon.png" style="width:76px; height:76px; border-radius:18px;" />
          </div>
          <div class="profile-hero-text">
            <p class="profile-hero-eyebrow">WormJB Identity</p>
            <h2 id="profileHeroName">WormJB User</h2>
            <p>Personalize how your presence appears across WormJB. Changes sync instantly across the app.</p>
          </div>
        </div>
        <div class="profile-form">
          <div class="profile-field">
            <label for="profileUsername">Display Name</label>
            <input id="profileUsername" class="ios-input" placeholder="WormJB User" />
            <small>Appears in the header, welcome banner, and alerts.</small>
          </div>
          <div class="profile-field">
            <label>Display Mode</label>
            <div class="profile-mode-toggle" role="radiogroup">
              <label class="profile-mode-pill" data-mode="icon">
                <input type="radio" name="profileMode" value="icon" id="modeIcon">
                <span>Icon Mode</span>
              </label>
              <label class="profile-mode-pill" data-mode="button">
                <input type="radio" name="profileMode" value="button" id="modeButton">
                <span>Button Mode</span>
              </label>
            </div>
            <small>Icon Mode keeps the username next to your avatar. Button Mode wraps everything into a pill button.</small>
          </div>
          <div class="profile-field profile-upload">
            <label for="profileIconFile">Profile Icon</label>
            <input id="profileIconFile" type="file" accept="image/*" />
            <small>Image stays local in your browser. Nothing is uploaded.</small>
          </div>
          <div class="profile-actions">
            <button class="ios-button" id="closeProfileBtn">Cancel</button>
            <button class="ios-button" id="saveProfileBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="ios-card">
        <h3>Settings</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Enable Logs</span>
            <label class="ios-switch">
              <input type="checkbox"><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item">
            <span>Auto-update</span>
            <label class="ios-switch">
              <input type="checkbox" checked><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item" onclick="promptDebugCode()">
            <span style="color: var(--ios-blue);">Debug</span>
          </div>
        </div>
      </div>
      <div class="ios-card">
        <h3>Appearance</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Theme</span>
            <select id="themeModeSelect" class="ios-input" style="width:auto;">
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="ios-list-item">
            <span>Custom Background</span>
            <input type="color" id="customBgColor" class="ios-input" style="width:64px; padding:0;">
            <button class="ios-button" id="resetBgBtn" style="margin-left:.5rem;">Reset</button>
          </div>
          <div class="ios-list-item" style="flex-direction:column; align-items:flex-start; gap:.35rem;">
            <div style="display:flex; align-items:center; gap:.5rem; width:100%; justify-content:space-between;">
              <span>Font</span>
              <div style="display:flex; align-items:center; gap:.5rem;">
                <select id="themeFontSelect" class="ios-input" style="width:120px;">
                  <option value="system">System</option>
                  <option value="inter">Inter</option>
                  <option value="other">Other...</option>
                </select>
                <input id="themeFontOther" class="ios-input" placeholder="Font-family (e.g. 'Roboto')" style="display:none; width:160px;" />
              </div>
            </div>
          </div>
          <div class="ios-list-item">
            <span>Glass Mode</span>
            <label class="ios-switch"><input type="checkbox" id="glassModeToggle"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Enable Ambient Sound</span>
            <label class="ios-switch"><input type="checkbox" id="musicEnableToggle"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Tall Tabs (notched)</span>
            <label class="ios-switch"><input type="checkbox" id="tabsNotchToggle"><span class="slider"></span></label>
          </div>
        </div>
      </div>
      <div class="ios-card system-info-card">
        <div class="card-title-row">
          <h3>System Info</h3>
          <span id="sysModeBadge" class="sys-mode-pill">—</span>
        </div>
        <div id="sysInfoList" class="sys-info-grid">
          <div class="sys-info-item">
            <span class="sys-info-label">Version</span>
            <span class="sys-info-value" id="sysVersion">—</span>
          </div>
          <div class="sys-info-item">
            <span class="sys-info-label">Device</span>
            <span class="sys-info-value" id="sysDevice">—</span>
          </div>
        </div>
        <div id="sysTestingPanel" class="sys-testing-panel" style="display:none;" role="status">
          <div class="sys-testing-heading">
            <span class="testing-pill">Testing Mode</span>
            <span class="testing-dot"></span>
          </div>
          <p id="sysTestingCopy">WormJB is running in preview mode. Secure actions stay disabled here so you can safely test UI changes.</p>
          <ul>
            <li>Smooth animations, layouts, and fonts still match the device experience.</li>
            <li>Use this mode to validate tweaks before shipping to real devices.</li>
            <li>Switch to a mobile browser to unlock the full WormJB toolchain.</li>
          </ul>
        </div>
      </div>
      <div class="ios-card credits-card">
        <div class="credits-header">
          <h3 style="margin-bottom:0.25rem;">Credits</h3>
          <p class="credits-subtitle">WormJB exists thanks to this small roster of obsessives.</p>
        </div>
        <div class="credits-grid">
          <div class="credit-item">
            <span class="credit-label">Founder</span>
            <span class="credit-value">wheatbread2056 · brainworm</span>
          </div>
          <div class="credit-item">
            <span class="credit-label">Lead Developer</span>
            <span class="credit-value">GPT-5 · OpenAI</span>
          </div>
          <div class="credit-item">
            <span class="credit-label">Engineering</span>
            <span class="credit-value">wheatbread2056</span>
          </div>
          <div class="credit-item">
            <span class="credit-label">Inspiration</span>
            <span class="credit-value">cydia gold edition team</span>
          </div>
          <div class="credit-item">
            <span class="credit-label">License</span>
            <span class="credit-value">None. Chaos only.</span>
          </div>
          <div class="credit-item">
            <span class="credit-label">App Version</span>
            <span class="credit-value" id="creditsVersion">—</span>
          </div>
        </div>
      </div>
    </section>

    <section id="devsettings">
      <div class="ios-card">
        <h3>Developer Settings</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Verbose Logs</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Experimental Mode</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Force Apple Font (Web)</span>
            <label class="ios-switch">
              <input type="checkbox" id="forceAppleFontToggle"><span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: .75rem; flex-wrap:wrap;">
          <button class="ios-button danger" onclick="clearAppData()">Clear App Data & Reload</button>
          <button class="ios-button" id="disableDevBtn">Disable Dev Mode</button>
          <button class="ios-button" id="reloadAppBtn">Reload App</button>
          <button class="ios-button" id="exportDataBtn">Export Data (.wormdata)</button>
          <input id="importDataInput" type="file" accept=".wormdata,application/json" style="display:none;" />
          <button class="ios-button" id="importDataBtn">Import Data (.wormdata)</button>
          <button class="ios-button" id="openConsoleBtn">Open JS Console</button>
        </div>
      </div>
    </section>
  </main>

  <div id="alert" class="ios-alert">
    <h3>WormJB</h3>
    <p id="alert-text">Placeholder text</p>
    <button class="ios-button" onclick="hideAlert()">OK</button>
  </div>

  <!-- Background audio (loop) -->
  <audio id="bgAudio" preload="auto"></audio>

  <nav class="tabs" id="tab-bar">
    <div class="tab" data-tab="tweaks">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-5"/><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      <span>Tweaks</span>
    </div>
    <div class="tab active" data-tab="home">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/></svg>
      <span>Home</span>
    </div>
    <div class="tab" data-tab="settings">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 5.6a1.65 1.65 0 0 0 1-1.51V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span>Settings</span>
    </div>
  </nav>

  <script>
  const tabs = document.querySelectorAll('.tab');
  const sections = document.querySelectorAll('section');
  const tabBar = document.getElementById('tab-bar');
  const prefersReducedMotion = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;

  function syncAppVersion() {
    const version = (typeof APP_VERSION !== 'undefined' && APP_VERSION) ? APP_VERSION : '—';
    const pill = document.getElementById('appVersion');
    const credits = document.getElementById('creditsVersion');
    if (pill) pill.textContent = version;
    if (credits) credits.textContent = version;
  }

  syncAppVersion();

    window.addEventListener('load', () => document.body.classList.add('ready'));
    if (prefersReducedMotion) {
      document.body.classList.toggle('reduced-motion', prefersReducedMotion.matches);
      prefersReducedMotion.addEventListener('change', () => {
        document.body.classList.toggle('reduced-motion', prefersReducedMotion.matches);
        try { renderTweaks(); } catch(e) {}
        try { renderReposList(); if (currentRepoId) renderRepoItems(); } catch(e) {}
      });
    }

    function shouldReduceMotion() {
      return !!(prefersReducedMotion && prefersReducedMotion.matches);
    }

    function playSectionEnter(section) {
      if (!section || shouldReduceMotion()) return;
      section.classList.remove('section-enter');
      // force reflow so animation can retrigger
      void section.offsetWidth;
      section.classList.add('section-enter');
    }

    function prepareAnimatedListItem(el, index) {
      if (!el) return;
      el.style.setProperty('--stagger-index', index || 0);
      if (shouldReduceMotion()) {
        el.classList.remove('animate-list-item');
        return;
      }
      el.classList.remove('animate-list-item');
      void el.offsetWidth;
      el.classList.add('animate-list-item');
    }

    function switchTab(target) {
      // Use fresh queries so dynamically added tabs (Dev) are handled
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.tab[data-tab="${target}"]`);
      if (tab) tab.classList.add('active');
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      const section = document.getElementById(target);
      if (section) {
        section.classList.add('active');
        playSectionEnter(section);
      }
    }

    tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

    function showModal(el) {
      if (!el) return;
      el.classList.remove('closing');
      // force reflow so reopening after a close anim replays entrance
      void el.offsetWidth;
      el.classList.add('visible');
    }

    function hideModal(el) {
      if (!el) return;
      const finish = () => {
        el.classList.remove('visible');
        el.classList.remove('closing');
        el.removeEventListener('transitionend', onEnd);
      };
      const onEnd = (evt) => {
        if (evt && evt.target !== el) return;
        finish();
      };
      el.classList.add('closing');
      const duration = parseFloat(getComputedStyle(el).transitionDuration) || 0;
      const delay = parseFloat(getComputedStyle(el).transitionDelay) || 0;
      const total = (duration + delay) * 1000;
      if (total === 0) {
        finish();
        return;
      }
      el.addEventListener('transitionend', onEnd);
      // Safety timeout in case transitionend doesn't fire
      setTimeout(finish, total + 50);
    }

    function showAlert(msg) {
      const alertBox = document.getElementById('alert');
      document.getElementById('alert-text').textContent = msg;
      showModal(alertBox);
    }
    function hideAlert() {
      hideModal(document.getElementById('alert'));
    }

    function promptDebugCode() {
      const unlocked = localStorage.getItem('devUnlocked');
      if (unlocked === 'true') {
        showDevTab();
        switchTab('devsettings');
        return;
      }
      const code = prompt('Enter debug code:');
      if (code === 'brainworm') {
        localStorage.setItem('devUnlocked', 'true');
        showDevTab();
        switchTab('devsettings');
      }
    }

    function showDevTab() {
      if (!document.querySelector('.tab[data-tab=\"devsettings\"]')) {
        const devTab = document.createElement('div');
        devTab.className = 'tab';
        devTab.dataset.tab = 'devsettings';
        devTab.innerHTML = `
          <svg fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" viewBox=\"0 0 24 24\"><path d=\"M9 18l6-6-6-6\"/></svg>
          <span>Dev</span>`;
        devTab.addEventListener('click', () => switchTab('devsettings'));
        tabBar.appendChild(devTab);
      }
    }

    if (localStorage.getItem('devUnlocked') === 'true') {
      showDevTab();
    }

  // Font forcing (Apple-like font using Inter from web)
  const FORCE_FONT_KEY = 'forceAppleFont';
  const THEME_FONT_CHOICE_KEY = 'themeFontChoice';
  const THEME_FONT_OTHER_KEY = 'themeFontOther';
  const SYSTEM_FONT_STACK = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
  const INTER_FONT_STACK = "'Inter', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";

    function ensureInterLoaded() {
      if (document.getElementById('interFontLink')) return;
      const link = document.createElement('link');
      link.id = 'interFontLink';
      link.rel = 'stylesheet';
      link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap';
      document.head.appendChild(link);
    }

    function resolveThemeFontStack() {
      const fontChoice = localStorage.getItem(THEME_FONT_CHOICE_KEY) || 'system';
      const fontOther = (localStorage.getItem(THEME_FONT_OTHER_KEY) || '').trim();
      if (fontChoice === 'inter') {
        ensureInterLoaded();
        return INTER_FONT_STACK;
      }
      if (fontChoice === 'other' && fontOther) {
        return `${fontOther}, ${SYSTEM_FONT_STACK}`;
      }
      return SYSTEM_FONT_STACK;
    }

    function syncDocumentFont() {
      const forceApple = localStorage.getItem(FORCE_FONT_KEY) === 'true';
      document.documentElement.classList.toggle('force-apple-font', forceApple);
      if (forceApple) {
        ensureInterLoaded();
        document.documentElement.style.removeProperty('--app-font-family');
        return;
      }
      const stack = resolveThemeFontStack();
      document.documentElement.style.setProperty('--app-font-family', stack);
    }

    function setForceAppleFont(enabled) {
      localStorage.setItem(FORCE_FONT_KEY, enabled ? 'true' : 'false');
      if (enabled) ensureInterLoaded();
      syncDocumentFont();
      const cb = document.getElementById('forceAppleFontToggle');
      if (cb) cb.checked = !!enabled;
    }

    // Initialize state from storage
    if (localStorage.getItem(FORCE_FONT_KEY) === 'true') {
      setForceAppleFont(true);
    }

    // Wire toggle if present
    (function attachFontToggle() {
      const cb = document.getElementById('forceAppleFontToggle');
      if (!cb) return;
      cb.checked = localStorage.getItem(FORCE_FONT_KEY) === 'true';
      cb.addEventListener('change', (e) => setForceAppleFont(e.target.checked));
    })();

    // ---------- Tweaks rendering and persistence ----------
    const TWEAKS_KEY = 'wormjb_tweaks_v1';

    function defaultTweaks() {
      return [
        { id: 'tweak.wormjb.hookworm', name: 'Hookworm', description: 'The WormJB tweak loader', author: 'wormjb', version: '1.0', date: '2025-11-11', bg: '#f7b2f0', enabled: true },
        { id: 'tweak.pissrain.respring', name: 'Respring Support', description: 'Respring support for wormJB', author: 'Pissra1n tweak devs', version: '0.3.1', date: '2025-06-12', bg: '#b9f7b2', enabled: true },
        { id: 'app.sileo.demo', name: 'Sileo Demo', description: 'Sileo Demo ipa installer', version: '0.8b11', author: 'Sileo Team', date: '2025-10-30', bg: '#9fe8f2', enabled: false, onEnable: "window.open('https://raw.githubusercontent.com/wheatbread2056/wormjbrepo/main/Sileo_Demo_0.8b11.ipa', '_blank');" }
      ];
    }

    function loadTweaks() {
      try {
        const raw = localStorage.getItem(TWEAKS_KEY);
        if (!raw) return defaultTweaks();
        return JSON.parse(raw);
      } catch (e) { return defaultTweaks(); }
    }

    function saveTweaks(tweaks) {
      localStorage.setItem(TWEAKS_KEY, JSON.stringify(tweaks));
    }

    function renderTweaks() {
      const container = document.getElementById('tweak-container');
      const tweaks = loadTweaks();
      container.innerHTML = '';
      tweaks.forEach((t, idx) => {
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.style.display = 'flex';
        item.style.flexDirection = 'row';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.background = resolveTweakBg(t.bg || 'white');
        item.style.borderBottom = '1px solid var(--ios-border)';
        item.style.padding = '0.75rem';

        const left = document.createElement('div');
        left.className = 'tweak-left';
        left.style.marginRight = '0.75rem';
        left.innerHTML = `
          <div class="tweak-title-row">
            <strong class="tweak-name">${escapeHtml(t.name)}</strong>
          </div>
          <div class="tweak-desc">${escapeHtml(t.description)}</div>
          <div class="tweak-meta">By ${escapeHtml(t.author)} • v${escapeHtml(t.version)} • ${escapeHtml(t.date)}</div>
        `;

  const right = document.createElement('div');
  right.className = 'tweak-right';

  item.style.position = 'relative';
  const idTag = document.createElement('div');
  idTag.className = 'tweak-id-floating';
  idTag.textContent = t.id || '';
  idTag.title = t.id || '';
  item.appendChild(idTag);

        const label = document.createElement('label');
        label.className = 'ios-switch';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!t.enabled;
        const span = document.createElement('span');
        span.className = 'slider';
        label.appendChild(checkbox);
        label.appendChild(span);

        checkbox.addEventListener('change', () => {
          const ts = loadTweaks();
          const tw = ts[idx];
          const goingEnabled = checkbox.checked;
          let proceed = true;
          const msg = goingEnabled ? tw.enableConfirmationPrompt : tw.disableConfirmationPrompt;
          if (msg && typeof msg === 'string' && msg.trim()) {
            proceed = confirm(msg);
          }
          if (!proceed) {
            checkbox.checked = !goingEnabled;
            return;
          }
          tw.enabled = goingEnabled;
          saveTweaks(ts);
          if (goingEnabled && tw.onEnable && tw.onEnable.trim()) {
            try {
              // Run in isolated function scope
              new Function(tw.onEnable)();
            } catch (e) {
              console.error('onEnable error:', e);
              showAlert('onEnable error: ' + (e && e.message ? e.message : e));
            }
          }
        });

        right.appendChild(label);

        // If dev unlocked, show settings button
        if (localStorage.getItem('devUnlocked') === 'true') {
          const settingsBtn = document.createElement('button');
          settingsBtn.className = 'ios-button';
          settingsBtn.textContent = 'Settings';
          settingsBtn.style.padding = '0.4rem 0.6rem';
          settingsBtn.addEventListener('click', () => openTweakEditor(idx));
          right.appendChild(settingsBtn);
        }

        item.appendChild(left);
        item.appendChild(right);
        prepareAnimatedListItem(item, idx);
        container.appendChild(item);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Tweak editor modal
    let currentEditIndex = null;
    function openTweakEditor(idx) {
      const tweaks = loadTweaks();
      const t = tweaks[idx];
      if (!t) return;
      currentEditIndex = idx;
      document.getElementById('tweakName').value = t.name || '';
      document.getElementById('tweakId').value = t.id || '';
      document.getElementById('tweakDesc').value = t.description || '';
      document.getElementById('tweakAuthor').value = t.author || '';
      document.getElementById('tweakVersion').value = t.version || '';
      document.getElementById('tweakDate').value = t.date || '';
      document.getElementById('tweakBg').value = t.bg || '';
      document.getElementById('tweakOnEnable').value = t.onEnable || '';
      document.getElementById('tweakEnablePrompt').value = t.enableConfirmationPrompt || '';
      document.getElementById('tweakDisablePrompt').value = t.disableConfirmationPrompt || '';
      const modal = document.getElementById('tweakModal');
      showModal(modal);
    }

    function closeTweakModal() {
      hideModal(document.getElementById('tweakModal'));
      currentEditIndex = null;
    }

    document.getElementById('saveTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      if (currentEditIndex === null) { closeTweakModal(); return; }
      tweaks[currentEditIndex] = {
        id: document.getElementById('tweakId').value,
        name: document.getElementById('tweakName').value,
        description: document.getElementById('tweakDesc').value,
        author: document.getElementById('tweakAuthor').value,
        version: document.getElementById('tweakVersion').value,
        date: document.getElementById('tweakDate').value,
        bg: document.getElementById('tweakBg').value,
        enabled: tweaks[currentEditIndex].enabled,
        onEnable: document.getElementById('tweakOnEnable').value,
        enableConfirmationPrompt: document.getElementById('tweakEnablePrompt').value,
        disableConfirmationPrompt: document.getElementById('tweakDisablePrompt').value
      };
      saveTweaks(tweaks);
      closeTweakModal();
      renderTweaks();
    });

    const deleteBtn = document.getElementById('deleteTweakBtn');
    if (deleteBtn) deleteBtn.addEventListener('click', () => {
      const tweaks = loadTweaks();
      if (currentEditIndex === null) { closeTweakModal(); return; }
      tweaks.splice(currentEditIndex, 1);
      saveTweaks(tweaks);
      closeTweakModal();
      renderTweaks();
    });

  // Show alert remains same but ensure modal can be reused
  // render initially
  renderTweaks();

    // ---------- Profile management and Add Tweak ----------
    const PROFILE_KEY = 'wormjb_profile_v1';

    function loadProfile() {
      try { return JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}'); } catch (e) { return {}; }
    }

    function saveProfile(p) { localStorage.setItem(PROFILE_KEY, JSON.stringify(p || {})); }

    function applyProfileToHeader() {
      const p = loadProfile();
      const name = p.username || 'WormJB User';
      const icon = p.icon || 'assets/wormjbicon.png';
      const mode = p.displayMode || 'icon';

      // Header username (left-side). Only shown in Icon Mode; hidden in Button Mode.
      const headerUsernameEl = document.getElementById('headerUsername');
      if (headerUsernameEl) headerUsernameEl.textContent = name;

      // Profile icon elements
      const img = document.getElementById('profileIcon');
      const imgLarge = document.getElementById('profileIconLarge');
      if (img) img.src = icon;
      if (imgLarge) imgLarge.src = icon;
  const heroName = document.getElementById('profileHeroName');
  if (heroName) heroName.textContent = name;

  // Use username as tooltip on the icon/button
  const wrap = document.getElementById('headerProfileWrap');
  if (wrap) wrap.title = name;

      // Set the button label inside the profile button (used in Button Mode)
      const btnLabel = document.getElementById('profileBtnLabel');
      if (btnLabel) btnLabel.textContent = name;

      // Reflect mode in header rendering
      renderProfileDisplayMode(mode);

      // populate profile fields in profile panel
      const inputUser = document.getElementById('profileUsername');
      const modeIcon = document.getElementById('modeIcon');
      const modeButton = document.getElementById('modeButton');
      if (inputUser) inputUser.value = p.username || '';
      if (modeIcon) modeIcon.checked = (mode === 'icon');
      if (modeButton) modeButton.checked = (mode === 'button');
    }

    function renderProfileDisplayMode(mode) {
      const headerUsernameEl = document.getElementById('headerUsername');
      const profileBtn = document.getElementById('profileBtn');
      const profileIcon = document.getElementById('profileIcon');
      const profileBtnLabel = document.getElementById('profileBtnLabel');
      if (!profileBtn || !profileIcon) return;

      if (mode === 'button') {
        // Button Mode: hide left username, style the profile as a button with icon + username inside
        if (headerUsernameEl) headerUsernameEl.style.display = 'none';
        // Clear any icon-mode inline styles that could suppress button look
        profileBtn.style.background = '';
        profileBtn.style.border = '';
        profileBtn.classList.add('ios-button');
        profileBtn.style.padding = '0.3rem 0.6rem';
        profileBtnLabel.style.display = 'inline';
        // ensure aria/tooltip shows fullname via parent title
        profileBtn.setAttribute('aria-label', profileBtnLabel.textContent || 'Profile');
      } else {
        // Icon Mode: show username to the left, render the icon as an unstyled icon button
        if (headerUsernameEl) headerUsernameEl.style.display = 'inline-block';
        profileBtn.classList.remove('ios-button');
        profileBtn.style.padding = '0';
        profileBtnLabel.style.display = 'none';
        profileBtn.style.background = 'transparent';
        profileBtn.style.border = 'none';
      }

      // Ensure the icon image remains clickable but visually appropriate
      profileIcon.style.width = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.height = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.borderRadius = '4px';

      document.querySelectorAll('.profile-mode-pill').forEach(pill => {
        if (!pill.dataset.mode) return;
        pill.classList.toggle('active', pill.dataset.mode === mode);
      });
    }

    document.getElementById('profileBtn').addEventListener('click', () => {
      // Open real Profile page as a section/tab
      switchTab('profile');
      applyProfileToHeader();
    });

    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      switchTab('home');
    });

    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      const mode = (document.getElementById('modeButton') && document.getElementById('modeButton').checked) ? 'button' : 'icon';
      const p = {
        username: document.getElementById('profileUsername').value,
        // Keep any previously saved icon (uploads are handled elsewhere), fallback to default
        icon: (loadProfile().icon) || 'assets/wormjbicon.png',
        displayMode: mode
      };
      saveProfile(p);
      applyProfileToHeader();
      showAlert('Profile saved');
    });

    // Live preview when switching display mode in profile panel
    const modeIconRadio = document.getElementById('modeIcon');
    const modeButtonRadio = document.getElementById('modeButton');
    if (modeIconRadio) modeIconRadio.addEventListener('change', () => { if (modeIconRadio.checked) renderProfileDisplayMode('icon'); });
    if (modeButtonRadio) modeButtonRadio.addEventListener('change', () => { if (modeButtonRadio.checked) renderProfileDisplayMode('button'); });

    // Dev UI updates that depend on devUnlocked (no longer hide Add Tweak)
    function updateDevUI() {
      // currently nothing to toggle besides dev-only content in tweaks (renderTweaks handles that)
    }

    document.getElementById('addTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      const newT = { id: 'tweak.' + Date.now(), name: 'New Tweak', description: '', author: '', version: '0.1', date: new Date().toISOString().slice(0,10), bg: '#ffffff', enabled: false };
      tweaks.unshift(newT);
      saveTweaks(tweaks);
      renderTweaks();
      // open editor for the new tweak (index 0)
      openTweakEditor(0);
    });

    // Browser data: varied tweaks (naming conventions, versions, dates) and some apps
    function slugifyName(n){
      return String(n).toLowerCase().replace(/[^a-z0-9]+/g,'').trim();
    }
    const REPO_ITEMS = [
      // Tweaks
      { type:'tweak', name:'AeroDock', desc:'Sleek dock transparency for Home Screen.', ver:'1.0.0', date:'2025-01-15', author:'azuki', bg:'#eef7ff' },
      { type:'tweak', name:'ClearBadge+', desc:'Clear badges with a pull gesture.', ver:'1.2.3', date:'2025-02-01', author:'mara', bg:'#fef3c7' },
      { type:'tweak', name:'StatusFlex 2', desc:'Customize status bar elements.', ver:'2.0.0', date:'2025-02-20', author:'luke', bg:'#f3f4f6' },
      { type:'tweak', name:'Night Owl (Beta)', desc:'True system-wide dark enhancement.', ver:'0.9.0-beta', date:'2025-03-05', author:'nero', bg:'#1118270d' },
      { type:'tweak', name:'QuickSettings Pro', desc:'Fast toggles in Control Center.', ver:'3.1.4', date:'2025-03-22', author:'olive', bg:'#ecfccb' },
      { type:'tweak', name:'LiveBattery Ring', desc:'Live battery ring on icons.', ver:'1.0.5', date:'2025-04-10', author:'finn', bg:'#f5f3ff' },
      { type:'tweak', name:'SnapGrid', desc:'Snap icons to a neat grid.', ver:'1.3.0', date:'2025-04-28', author:'kai', bg:'#e0f2fe' },
      { type:'tweak', name:'SilentTap', desc:'Silence camera shutter with a tap.', ver:'0.9.9', date:'2025-05-09', author:'zoe', bg:'#fef2f2' },
      { type:'tweak', name:'AppLocker', desc:'Passcode protect chosen apps.', ver:'2.4.1', date:'2025-05-21', author:'ian', bg:'#f3e8ff' },
      { type:'tweak', name:'UI Rounder', desc:'Round UI corners system-wide.', ver:'1.0', date:'2025-06-01', author:'xeno', bg:'#f0fdf4' },
      { type:'tweak', name:'EdgeSwipe', desc:'Gesture from edges to switch apps.', ver:'1.0.7', date:'2025-06-12', author:'vera', bg:'#fff7ed' },
      { type:'tweak', name:'HaptiTune', desc:'Fine-tune haptics feedback.', ver:'1.5.0', date:'2025-06-30', author:'noah', bg:'#f1f5f9' },
      { type:'tweak', name:'LockGlyph', desc:'Animated lock glyph on unlock.', ver:'1.2', date:'2025-07-08', author:'gale', bg:'#fef9c3' },
      { type:'tweak', name:'ScreenDimmer X', desc:'Auto-dim screen intelligently.', ver:'10.0', date:'2025-07-20', author:'ivy', bg:'#fafafa' },
      { type:'tweak', name:'IconWeaver', desc:'Weave custom icon overlays.', ver:'0.8.2', date:'2025-08-01', author:'sol', bg:'#ffe4e6' },
      { type:'tweak', name:'TintKit+', desc:'Global tint color control.', ver:'1.1.1', date:'2025-08-14', author:'tori', bg:'#fefce8' },
      { type:'tweak', name:'Music Bar Lite', desc:'Compact music bar on Home.', ver:'1.0.2', date:'2025-08-29', author:'milo', bg:'#eff6ff' },
      { type:'tweak', name:'PopupKill 2', desc:'Auto-close annoying popups.', ver:'2.0.3', date:'2025-09-09', author:'aria', bg:'#f0f9ff' },
      { type:'tweak', name:'ReachPlus', desc:'Extended reachability options.', ver:'3.0.0', date:'2025-09-20', author:'rhett', bg:'#f7fee7' },
      { type:'tweak', name:'QuietHours', desc:'Schedule silence times.', ver:'1.4.6', date:'2025-10-01', author:'yuna', bg:'#f8fafc' },
      { type:'tweak', name:'ShadowLess', desc:'Remove icon drop-shadows.', ver:'1.0', date:'2025-10-12', author:'zane', bg:'#f5f5f5' },
      { type:'tweak', name:'FolderArt', desc:'Custom images for folders.', ver:'0.4.0', date:'2025-10-18', author:'dina', bg:'#faf5ff' },
      { type:'tweak', name:'HUD Lite', desc:'Minimal volume HUD.', ver:'1.7.2', date:'2025-10-25', author:'quinn', bg:'#f0fdfa' },
      { type:'tweak', name:'Springy', desc:'Bouncy spring animations.', ver:'4.0.0', date:'2025-11-01', author:'brea', bg:'#fff1f2' },
      { type:'tweak', name:'BlurBoost', desc:'Sharper blur performance.', ver:'1.0.0', date:'2025-11-12', author:'lex', bg:'#f1f0ff' },
      // Extra tweaks
      { type:'tweak', name:'DockHider', desc:'Hide the dock until needed.', ver:'0.1.0', date:'2025-02-10', author:'azuki', bg:'#eef7ff' },
      { type:'tweak', name:'BadgeCounter Pro', desc:'Advanced badge counting.', ver:'1.8.9', date:'2025-03-17', author:'mara', bg:'#fef3c7' },
      { type:'tweak', name:'StatusGlyph', desc:'Icons in status bar.', ver:'0.6.4', date:'2025-04-04', author:'luke', bg:'#f3f4f6' },
      // Apps (do nothing; just listed)
      { type:'app', name:'FileVoyager', desc:'Powerful file browser.', ver:'2.3.0', date:'2025-06-06', author:'wormjb', bg:'#e0f2fe' },
      { type:'app', name:'TerminaLite', desc:'Lightweight terminal.', ver:'0.9.1', date:'2025-07-07', author:'wormjb', bg:'#f5f3ff' },
      { type:'app', name:'IconStudio', desc:'Design and export icons.', ver:'1.0.0', date:'2025-08-18', author:'wormjb', bg:'#f3e8ff' },
      { type:'app', name:'ThemeCraft', desc:'Build themes with ease.', ver:'1.2.0', date:'2025-09-22', author:'wormjb', bg:'#f0fdf4' }
    ];
    const DEFAULT_REPO = REPO_ITEMS.map(it => ({
      id: `${it.type === 'app' ? 'app' : 'tweak'}.${slugifyName(it.name)}`,
      name: it.name,
      description: it.desc,
      author: it.author,
      version: it.ver,
      date: it.date,
      bg: it.bg
    }));

    // (Old single-repo renderer removed; multi-repo system defined later)

    const browserBtn = document.getElementById('browserBtn');
    if (browserBtn) browserBtn.addEventListener('click', () => { renderReposList(); switchTab('tweakBrowser'); });
    const backFromBrowserBtn = document.getElementById('backFromBrowserBtn');
    if (backFromBrowserBtn) backFromBrowserBtn.addEventListener('click', () => switchTab('tweaks'));

    // System info rendering (status-style list). Enhances testing mode visuals on desktop.
    (function renderSystemInfo(){
      const ua = navigator.userAgent || '';
      const list = document.getElementById('sysInfoList');
      const verEl = document.getElementById('sysVersion');
      const devEl = document.getElementById('sysDevice');
      const testingPanel = document.getElementById('sysTestingPanel');
      const modeBadge = document.getElementById('sysModeBadge');
      if (!list || !verEl || !devEl || !testingPanel || !modeBadge) return;
      const isMobileUA = ua.indexOf('Mobile/') !== -1;
      if (isMobileUA) {
        let version = 'Unknown';
        const vIdx = ua.indexOf('Version/');
        if (vIdx !== -1) {
          const after = ua.slice(vIdx + 8);
          const m = after.match(/^([^\s;]+)/);
          version = m ? m[1] : after.split(' ')[0];
        }
        const device = navigator.platform || 'Unknown';
        verEl.textContent = version;
        devEl.textContent = device;
        list.style.display = 'grid';
        testingPanel.style.display = 'none';
        modeBadge.textContent = 'Device Linked';
        modeBadge.classList.remove('testing');
      } else {
        list.style.display = 'none';
        testingPanel.style.display = 'block';
        modeBadge.textContent = 'Testing Mode';
        modeBadge.classList.add('testing');
        const testingCopy = document.getElementById('sysTestingCopy');
        if (testingCopy) {
          const platform = navigator.userAgentData && navigator.userAgentData.platform ? navigator.userAgentData.platform : (navigator.platform || 'desktop');
          testingCopy.textContent = `You're previewing WormJB on ${platform}. Secure actions stay disabled here while visuals remain accurate.`;
        }
      }
    })();

    // Import/Export data
    const exportBtn = document.getElementById('exportDataBtn');
    if (exportBtn) exportBtn.addEventListener('click', () => {
      const data = { localStorage: { ...localStorage } };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'wormjb.wormdata';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    const importBtn = document.getElementById('importDataBtn');
    const importInput = document.getElementById('importDataInput');
    if (importBtn && importInput) {
      importBtn.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', () => {
        const file = importInput.files && importInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (parsed && parsed.localStorage) {
              Object.keys(parsed.localStorage).forEach(k => {
                try { localStorage.setItem(k, parsed.localStorage[k]); } catch(e) {}
              });
              showAlert('Data imported. Reloading...');
              setTimeout(()=>location.reload(), 600);
            }
          } catch (e) {
            showAlert('Import failed: ' + (e && e.message ? e.message : e));
          }
        };
        reader.readAsText(file);
      });
    }

    // Theme handling (system/light/dark + custom bg + font override)
  const THEME_MODE_KEY = 'themeMode'; // system|light|dark
  const CUSTOM_BG_KEY = 'customBg';
  const GLASS_MODE_KEY = 'glassMode';
  const MUSIC_ENABLED_KEY = 'musicEnabled';
  const MUSIC_LEGACY_DISABLED_KEY = 'musicDisabled';
  const TABS_NOTCH_KEY = 'tabsNotch';

  let audioElement = null;
  let pendingMusicPlayback = false;

  function isMusicEnabled() {
    if (localStorage.getItem(MUSIC_ENABLED_KEY) === null) {
      const legacy = localStorage.getItem(MUSIC_LEGACY_DISABLED_KEY);
      if (legacy !== null) {
        const enabledFromLegacy = legacy !== 'true';
        localStorage.setItem(MUSIC_ENABLED_KEY, enabledFromLegacy ? 'true' : 'false');
        localStorage.removeItem(MUSIC_LEGACY_DISABLED_KEY);
      }
    }
    return localStorage.getItem(MUSIC_ENABLED_KEY) === 'true';
  }

  function setMusicEnabled(enabled) {
    localStorage.setItem(MUSIC_ENABLED_KEY, enabled ? 'true' : 'false');
    if (!enabled && audioElement) {
      try { audioElement.pause(); audioElement.currentTime = 0; } catch (e) {}
    } else if (enabled) {
      requestMusicPlayback();
    }
    syncMusicUI();
  }

  function syncMusicUI() {
    const btn = document.getElementById('audioToggleBtn');
    const toggle = document.getElementById('musicEnableToggle');
    const enabled = isMusicEnabled();
    if (btn) {
      const isPlaying = audioElement && !audioElement.paused;
      if (!enabled) {
        btn.textContent = 'Enable Ambient Sound';
      } else {
        btn.textContent = isPlaying ? 'Ambient Sound Playing' : 'Restart Ambient Sound';
      }
      btn.disabled = false;
      btn.style.opacity = enabled ? '0.85' : '1';
    }
    if (toggle) toggle.checked = enabled;
  }

  function requestMusicPlayback() {
    if (!isMusicEnabled()) return;
    if (!audioElement) {
      pendingMusicPlayback = true;
      return;
    }
    pendingMusicPlayback = false;
    const tryPlay = () => audioElement.play().catch(() => {
      const resume = () => {
        audioElement.play().finally(() => {
          document.removeEventListener('pointerdown', resume, true);
          document.removeEventListener('keydown', resume, true);
        });
      };
      document.addEventListener('pointerdown', resume, true);
      document.addEventListener('keydown', resume, true);
    });
    tryPlay();
  }

    function applyTheme() {
      const mode = localStorage.getItem(THEME_MODE_KEY) || 'system';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = mode === 'dark' || (mode === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      const customBg = localStorage.getItem(CUSTOM_BG_KEY) || '';
      const bg = customBg || (dark ? '#0b0b0d' : '#ffffff');
      const border = dark ? '#2a2d34' : '#c6c6c8';
      const textGray = dark ? '#a1a1aa' : '#555';
      document.documentElement.style.setProperty('--ios-bg', bg);
      document.documentElement.style.setProperty('--ios-border', border);
      document.documentElement.style.setProperty('--ios-text-gray', textGray);
    // Font handling: system | inter | other
    const fontChoice = localStorage.getItem(THEME_FONT_CHOICE_KEY) || 'system';
    const fontOther = localStorage.getItem(THEME_FONT_OTHER_KEY) || '';
    if (fontSelect) fontSelect.value = fontChoice;
    if (fontOtherInput) { fontOtherInput.value = fontOther; fontOtherInput.style.display = (fontChoice==='other') ? 'inline-block' : 'none'; }
      syncDocumentFont();
      const storedGlassPref = localStorage.getItem(GLASS_MODE_KEY);
      const glassEnabled = storedGlassPref === null ? true : storedGlassPref === 'true';
      if (storedGlassPref === null && glassEnabled) {
        localStorage.setItem(GLASS_MODE_KEY, 'true');
      }
    document.documentElement.classList.toggle('glass-mode', glassEnabled);
    const glassToggle = document.getElementById('glassModeToggle');
    if (glassToggle) glassToggle.checked = glassEnabled;
      // reflect selects
      const sel = document.getElementById('themeModeSelect');
      if (sel) sel.value = mode;
  const color = document.getElementById('customBgColor');
  if (color && customBg) color.value = customBg;
      // Re-render lists that depend on theme (for per-item bg transforms)
    try { renderTweaks(); } catch(e) {}
    try { renderReposList(); if (currentRepoId) renderRepoItems(); } catch(e) {}
  syncMusicUI();
      // Tabs notch handling
      const tabsNotch = localStorage.getItem(TABS_NOTCH_KEY);
      const enabledNotch = (tabsNotch === null ? 'true' : tabsNotch) === 'true';
      applyTabHeight(enabledNotch);
    }

    // Dark theme CSS variables (light/dark via .dark class)
    (function injectDarkCSS(){
      const style = document.createElement('style');
      style.textContent = `
        html.dark body { color: #fafafa; }
        /* Scope surface overrides to dark mode only */
        html.dark .ios-card, html.dark .ios-list { background: var(--ios-bg); border-color: var(--ios-border); }
        html.dark .ios-list-item { border-color: var(--ios-border); }
  html.dark header, html.dark .tabs { background: var(--ios-bg); border-color: var(--ios-border); color: var(--ios-text-gray); }
        /* Inputs/buttons get slight dark tweaks in dark mode */
        html.dark .ios-button { background: #2563eb; color: #fff; }
        html.dark .ios-button.danger { background: #ef4444; }
        html.dark .ios-input { background: #1a1d23; color: #e5e7eb; border-color: #2a2d34; }
        html.dark .slider { background-color: #333842; }
        html.dark .ios-switch input:checked + .slider { background-color: #2563eb; }
      `;
      document.head.appendChild(style);
    })();

  const themeSel = document.getElementById('themeModeSelect');
  const bgPicker = document.getElementById('customBgColor');
  const resetBgBtn = document.getElementById('resetBgBtn');
  const fontSelect = document.getElementById('themeFontSelect');
  const fontOtherInput = document.getElementById('themeFontOther');
  const musicToggle = document.getElementById('musicEnableToggle');
  const tabsNotchToggle = document.getElementById('tabsNotchToggle');
  const glassModeToggle = document.getElementById('glassModeToggle');
  if (themeSel) themeSel.addEventListener('change', ()=>{ localStorage.setItem(THEME_MODE_KEY, themeSel.value); applyTheme(); });
  if (bgPicker) bgPicker.addEventListener('input', ()=>{ localStorage.setItem(CUSTOM_BG_KEY, bgPicker.value || ''); applyTheme(); });
  if (resetBgBtn) resetBgBtn.addEventListener('click', ()=>{ localStorage.removeItem(CUSTOM_BG_KEY); if (bgPicker) bgPicker.value = '#ffffff'; applyTheme(); });
  if (fontSelect) fontSelect.addEventListener('change', ()=>{ localStorage.setItem(THEME_FONT_CHOICE_KEY, fontSelect.value); applyTheme(); });
  if (fontOtherInput) fontOtherInput.addEventListener('input', ()=>{ localStorage.setItem(THEME_FONT_OTHER_KEY, fontOtherInput.value || ''); applyTheme(); });
  if (musicToggle) { musicToggle.checked = isMusicEnabled(); musicToggle.addEventListener('change', ()=>{ setMusicEnabled(musicToggle.checked); }); }
  if (tabsNotchToggle) { tabsNotchToggle.checked = (localStorage.getItem(TABS_NOTCH_KEY) === null) ? true : (localStorage.getItem(TABS_NOTCH_KEY) === 'true'); tabsNotchToggle.addEventListener('change', ()=>{ localStorage.setItem(TABS_NOTCH_KEY, tabsNotchToggle.checked ? 'true' : 'false'); applyTabHeight(tabsNotchToggle.checked); }); }
  if (glassModeToggle) { glassModeToggle.checked = localStorage.getItem(GLASS_MODE_KEY) === 'true'; glassModeToggle.addEventListener('change', ()=>{ localStorage.setItem(GLASS_MODE_KEY, glassModeToggle.checked ? 'true' : 'false'); applyTheme(); }); }

    // Follow system changes when in system mode
    if (window.matchMedia) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', () => applyTheme());
    }

    // Reload button
    const reloadBtn = document.getElementById('reloadAppBtn');
    if (reloadBtn) reloadBtn.addEventListener('click', ()=>location.reload());

    // Apply theme at startup
    applyTheme();

    // Adjust tab height and main bottom spacing
    function applyTabHeight(enabled) {
      const tabBarEl = document.getElementById('tab-bar');
      const mainEl = document.querySelector('main');
      if (!tabBarEl || !mainEl) return;
      tabBarEl.classList.toggle('tall', !!enabled);
      const glassActive = document.documentElement.classList.contains('glass-mode');
      if (glassActive) {
  const pad = enabled ? 108 : 92;
  mainEl.style.bottom = '0px';
  mainEl.style.paddingBottom = `calc(${pad}px + env(safe-area-inset-bottom, 0px))`;
      } else {
        mainEl.style.paddingBottom = '';
        mainEl.style.bottom = enabled ? '80px' : '60px';
      }
    }

    // Local image upload for profile icon (stored as data URL in localStorage)
    (function setupProfileIconUpload() {
      const fileInput = document.getElementById('profileIconFile');
      if (!fileInput) return;
      fileInput.addEventListener('change', () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          const p = loadProfile();
          p.icon = dataUrl;
          saveProfile(p);
          applyProfileToHeader();
        };
        reader.readAsDataURL(file);
      });
    })();

    // apply profile & dev UI initially
    applyProfileToHeader();
    updateDevUI();

    // Update welcome title whenever profile applied
    function updateWelcomeTitle() {
      const p = loadProfile();
      const name = p.username || 'WormJB User';
      const el = document.getElementById('welcomeTitle');
      if (el) el.textContent = 'Welcome, ' + name;
    }
    updateWelcomeTitle();

    async function clearAppData() {
      const confirmClear = confirm('This will clear all saved data for this app (settings, caches, cookies) and reload. Dev menu will be locked again. Continue?');
      if (!confirmClear) return;

      try {
        // Ensure dev menu will be locked on next load
        try { localStorage.removeItem('devUnlocked'); } catch (e) {}

        // Local/session storage
        try { localStorage.clear(); } catch (e) {}
        try { sessionStorage.clear(); } catch (e) {}

        // IndexedDB (best-effort)
        try {
          if ('databases' in indexedDB && typeof indexedDB.databases === 'function') {
            const dbs = await indexedDB.databases();
            for (const db of dbs) {
              if (db && db.name) {
                try { indexedDB.deleteDatabase(db.name); } catch (e) {}
              }
            }
          }
        } catch (e) {}

        // Cache Storage
        try {
          if (window.caches && caches.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        } catch (e) {}

        // Service Workers
        try {
          if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
        } catch (e) {}

        // Cookies (best-effort for this origin)
        try {
          const cookies = document.cookie ? document.cookie.split(';') : [];
          for (const c of cookies) {
            const eqPos = c.indexOf('=');
            const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
            const expires = 'Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = `${name}=;expires=${expires};path=/`;
            // Attempt domain-scoped delete as well
            const host = location.hostname;
            document.cookie = `${name}=;expires=${expires};path=/;domain=${host}`;
            if (!host.startsWith('.')) {
              document.cookie = `${name}=;expires=${expires};path=/;domain=.${host}`;
            }
          }
        } catch (e) {}
      } finally {
        // Reload the page to reflect cleared state
        location.reload();
      }
    }

    // Home buttons wiring restored
    function wireButtons() {
      const removeBtn = document.getElementById('removeJBBtn');
      const sideStoreBtn = document.getElementById('installSideStoreBtn');
      const repoBtn = document.getElementById('openRepoBtn');
      const showScriptBtn = document.getElementById('showScriptBtn');
      const openTermBtn = document.getElementById('openTerminalBtn');
      const mysteryBtn = document.getElementById('mysteryBtn');
      if (removeBtn) removeBtn.addEventListener('click', () => { showAlert('I apologize'); });
      if (sideStoreBtn) sideStoreBtn.addEventListener('click', () => { window.open('https://sidestore.io#get-started', '_blank'); });
      if (repoBtn) repoBtn.addEventListener('click', () => { window.open('https://github.com/wheatbread2056/wormJB', '_blank'); });
      if (showScriptBtn) showScriptBtn.addEventListener('click', () => { window.open('https://github.com/wheatbread2056/wormJB/blob/main/jb/main.sh', '_blank'); });
      if (openTermBtn) openTermBtn.addEventListener('click', () => { window.location.href = 'ashell://'; });
      if (mysteryBtn) mysteryBtn.addEventListener('click', () => { showAlert('Absolutely nothing happened.'); });
    }
    wireButtons();

    // Multi-repo support (global scope)
    const REPOS_KEY = 'wormjb_repos_v1';
    let currentRepoId = null;
    let currentRepoFilter = 'all'; // all|tweak|app

    function loadRepos() {
      try {
        const raw = localStorage.getItem(REPOS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch(e){ return []; }
    }
    function saveRepos(repos){ localStorage.setItem(REPOS_KEY, JSON.stringify(repos)); }

    function getDefaultLocalRepo() {
      return {
        id: 'local',
        name: '(local) FAKE TWEAKS',
        description: 'these are all FAKE. THESE DO NOTHING!!!',
        icon: 'assets/wormjbicon.png',
        bg: '#f7b2f0',
        items: DEFAULT_REPO
      };
    }

    function getAllRepos() {
      const repos = loadRepos();
      const hasLocal1 = repos.some(r=>r.id==='local');
      const hasLocal2 = repos.some(r=>r.id==='local2');
      const injected = [];
      if (!hasLocal1) injected.push(getDefaultLocalRepo());
      if (!hasLocal2) injected.push({
        id: 'local2',
        name: '(local) brainworm\'s repo',
        description: 'actual "tweaks", they do stuff (50% vibecoded, 50% human-written)',
        icon: 'assets/wormjbicon.png',
        bg: '#f7b2f0',
        items: [
          {
            id: 'tweak.brainworm.useragent',
            name: 'useragent',
            description: 'get user agent from the wormJB webapp',
            author: 'brainworm',
            version: '0.0.1',
            date: '2025-11-15',
            bg: '#f7b2f0',
            type: 'tweak',
            onEnable: `(() => {
  const ua = navigator.userAgent || 'Unknown';
  alert(ua);
})()`
          },
          {
            id: 'tweak.brainworm.ddg',
            name: 'duckduckgo',
            description: 'search duckduckgo from the wormJB webapp',
            author: 'brainworm',
            version: '0.0.1',
            date: '2025-11-21',
            bg: '#9fe8f2',
            type: 'tweak',
            onEnable: `(() => {
            window.location.href = 'https://duckduckgo.com/';
          })()`
          },
          {
            id: 'tweak.brainworm.blockota',
            name: 'block ota',
            description: 'install nebula mobileconfig block ota',
            author: 'brainworm',
            version: '0.0.1',
            date: '2025-11-21',
            bg: '#b9f7b2',
            type: 'tweak',
            onEnable: `(() => {
            window.location.href = 'https://f.itsnebula.net/noota-26.mobileconfig';
          })()`
          },
          {
            id: 'app.githubcopilot.console',
            name: 'JS Console',
            description: 'js console',
            author: 'GitHub Copilot',
            version: '1.0',
            date: '2025-11-21',
            bg: '#fef3c7',
            type: 'app',
            onEnable: `(() => { window.location.href = 'assets/console.html'; })()`
          }
        ]
      });
      return [...injected, ...repos];
    }

    const reposListEl = document.getElementById('reposList');
    function renderReposList() {
      if (!reposListEl) return;
      reposListEl.innerHTML = '';
      const repos = getAllRepos();
      repos.forEach((repo, idx) => {
        const row = document.createElement('div');
        row.className = 'ios-list-item';
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.background = resolveTweakBg(repo.bg || 'white');
        const iconSrc = escapeHtml(repo.icon || 'assets/wormjbicon.png');
        const desc = escapeHtml(repo.description || '');
        row.innerHTML = `<div style="display:flex; align-items:center; gap:.6rem; min-width:0;">
          <img src="${iconSrc}" alt="repo icon" style="width:28px; height:28px; border-radius:6px; flex:0 0 auto;" />
          <div style="display:flex; flex-direction:column; min-width:0;">
            <strong style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(repo.name)}</strong>
            <small style="color:var(--ios-text-gray); white-space:normal; overflow:hidden; line-height:1.25; font-size:0.7rem;">${desc}</small>
          </div>
        </div>`;
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '.5rem';
        const openBtn = document.createElement('button');
        openBtn.className = 'ios-button';
        openBtn.textContent = 'Open';
        openBtn.style.padding = '.4rem .7rem';
        openBtn.addEventListener('click', ()=>{ openRepo(repo.id); });
        actions.appendChild(openBtn);
  if (!['local','local2'].includes(repo.id)) {
          const delBtn = document.createElement('button');
          delBtn.className = 'ios-button danger';
          delBtn.textContent = 'Delete';
          delBtn.style.padding = '.4rem .7rem';
          delBtn.addEventListener('click', ()=>{
            if (!confirm('Delete repo '+repo.name+'?')) return;
            const rs = getAllRepos().filter(r=>r.id!==repo.id);
            saveRepos(rs.filter(r=>!['local','local2'].includes(r.id)));
            renderReposList();
            showAlert('Repo deleted');
          });
          actions.appendChild(delBtn);
        }
        row.appendChild(actions);
        prepareAnimatedListItem(row, idx);
        reposListEl.appendChild(row);
      });
    }

    function openRepo(id) {
      const repos = getAllRepos();
      const repo = repos.find(r=>r.id===id);
      if (!repo) { showAlert('Repo not found'); return; }
      currentRepoId = id;
      currentRepoFilter = 'all';
      switchTab('repoItems');
      renderRepoItems();
    }

    function filteredItems(items) {
      if (currentRepoFilter==='all') return items;
      return items.filter(it => (currentRepoFilter==='tweak' ? it.id.startsWith('tweak.') || it.type==='tweak' : it.id.startsWith('app.') || it.type==='app'));
    }

    const repoTitleEl = document.getElementById('repoTitle');
    const repoItemsListEl = document.getElementById('repoItemsList');
    function renderRepoItems() {
      if (!repoItemsListEl) return;
      const repos = getAllRepos();
      const repo = repos.find(r=>r.id===currentRepoId);
      if (!repo) return;
      if (repoTitleEl) {
        const iconSrc = escapeHtml(repo.icon || 'assets/wormjbicon.png');
        repoTitleEl.innerHTML = `<span id="repoTitleText" style="display:flex; align-items:center; gap:.5rem;"><img src="${iconSrc}" alt="repo icon" style="width:24px; height:24px; border-radius:6px;" /> ${escapeHtml(repo.name)}</span>`;
        const origBg = repo.bg || '#ffffff';
        let titleColor = origBg;
        try { if (!isDarkMode()) { titleColor = invertBrightnessColor(origBg); } } catch(e) {}
        const spanEl = document.getElementById('repoTitleText');
        if (spanEl) spanEl.style.color = titleColor;
      }
      repoItemsListEl.innerHTML = '';
      const items = filteredItems(repo.items || []);
      // Placeholder categories for second local repo when empty
      if (repo.id === 'local2' && (repo.items || []).length === 0) {
        ['Tweaks','Apps','Other'].forEach(cat => {
          const row = document.createElement('div');
          row.className = 'ios-list-item';
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.innerHTML = `<strong>${escapeHtml(cat)}</strong><span style="color:var(--ios-text-gray);">No items</span>`;
          repoItemsListEl.appendChild(row);
        });
        return;
      }
      items.forEach((t, idx) => {
        const row = document.createElement('div');
        row.className = 'ios-list-item';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.background = resolveTweakBg(t.bg || 'white');
        const left = document.createElement('div');
        left.className = 'tweak-left';
        left.innerHTML = `
          <div class="tweak-title-row"><strong class="tweak-name">${escapeHtml(t.name)}</strong></div>
          <div class="tweak-desc">${escapeHtml(t.description)}</div>
          <div class="tweak-meta">By ${escapeHtml(t.author)} • v${escapeHtml(t.version)} • ${escapeHtml(t.date)}</div>
        `;
        const right = document.createElement('div');
        right.className = 'tweak-right';
        const installBtn = document.createElement('button');
        installBtn.className = 'ios-button';
        installBtn.textContent = 'Install';
        installBtn.addEventListener('click', () => {
          const tweaks = loadTweaks();
          if (tweaks.some(x=>x.id===t.id)) { showAlert('Already installed'); return; }
          tweaks.unshift({ ...t, enabled: false });
          saveTweaks(tweaks);
          showAlert('Installed '+t.name);
          renderTweaks();
        });
        right.appendChild(installBtn);
  row.style.position = 'relative';
  const idTag = document.createElement('div');
  idTag.className = 'tweak-id-floating';
  idTag.textContent = t.id || '';
  idTag.title = t.id || '';
  row.appendChild(left);
  row.appendChild(right);
  row.appendChild(idTag);
        prepareAnimatedListItem(row, idx);
        repoItemsListEl.appendChild(row);
      });
    }

    const backToReposBtn = document.getElementById('backToReposBtn');
    if (backToReposBtn) backToReposBtn.addEventListener('click', ()=>{ switchTab('tweakBrowser'); });

    const repoFilterAll = document.getElementById('repoFilterAll');
    const repoFilterTweaks = document.getElementById('repoFilterTweaks');
    const repoFilterApps = document.getElementById('repoFilterApps');
    if (repoFilterAll) repoFilterAll.addEventListener('click', ()=>{ currentRepoFilter='all'; renderRepoItems(); });
    if (repoFilterTweaks) repoFilterTweaks.addEventListener('click', ()=>{ currentRepoFilter='tweak'; renderRepoItems(); });
    if (repoFilterApps) repoFilterApps.addEventListener('click', ()=>{ currentRepoFilter='app'; renderRepoItems(); });

    // Add Repo modal logic
    const addRepoBtn = document.getElementById('addRepoBtn');
    const addRepoModal = document.getElementById('addRepoModal');
    const confirmAddRepoBtn = document.getElementById('confirmAddRepoBtn');
    const cancelAddRepoBtn = document.getElementById('cancelAddRepoBtn');
  function showAddRepoModal(){ if (addRepoModal) showModal(addRepoModal); }
  function hideAddRepoModal(){ if (addRepoModal) hideModal(addRepoModal); }
    if (addRepoBtn) addRepoBtn.addEventListener('click', showAddRepoModal);
    if (cancelAddRepoBtn) cancelAddRepoBtn.addEventListener('click', hideAddRepoModal);
    if (confirmAddRepoBtn) confirmAddRepoBtn.addEventListener('click', async ()=>{
      const name = (document.getElementById('newRepoName').value || '').trim();
      const url = (document.getElementById('newRepoUrl').value || '').trim();
      const jsonText = document.getElementById('newRepoJson').value.trim();
      if (!name) { showAlert('Repo name required'); return; }
      let items = [];
      async function fetchUrl(u){
        try {
          const res = await fetch(u);
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        } catch(e){ throw e; }
      }
      try {
        if (url) {
          items = await fetchUrl(url);
        } else if (jsonText) {
          items = JSON.parse(jsonText);
        } else {
          showAlert('Provide URL or JSON'); return;
        }
        if (!Array.isArray(items)) { showAlert('JSON must be an array of items'); return; }
        const normalized = items.map(it => {
          const type = (it.type === 'app') ? 'app' : 'tweak';
          const slug = slugifyName(it.name || 'item'+Date.now());
          const id = `${type}.${slug}`;
          return {
            id,
            name: it.name || slug,
            description: it.desc || it.description || '',
            author: it.author || 'unknown',
            version: it.ver || it.version || '1.0.0',
            date: it.date || new Date().toISOString().slice(0,10),
            bg: it.bg || '#ffffff',
            type
          };
        });
        const repos = getAllRepos().filter(r=>r.id!=='local');
        const repoId = slugifyName(name);
        if (getAllRepos().some(r=>r.id===repoId)) { showAlert('Repo ID already exists'); return; }
        repos.push({ id: repoId, name, items: normalized });
        saveRepos(repos);
        hideAddRepoModal();
        renderReposList();
        showAlert('Repo added');
      } catch(e){ showAlert('Failed: '+(e && e.message ? e.message : e)); }
    });
    (function setupCopyHash(){
      const btn = document.getElementById('copyHashBtn');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        const h = getDeviceHash();
        try { await navigator.clipboard.writeText(h); showAlert('Copied device hash: ' + h); }
        catch { showAlert('Device hash: ' + h); }
      });
    })();

    // Disable Dev Mode button
    (function setupDisableDevMode() {
      const btn = document.getElementById('disableDevBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        localStorage.removeItem('devUnlocked');
        // Remove Dev tab if present
        const devTab = document.querySelector('.tab[data-tab="devsettings"]');
        if (devTab) devTab.remove();
        updateDevUI();
        showAlert('Developer mode disabled');
        // If currently on devsettings, go home
        const activeDev = document.getElementById('devsettings').classList.contains('active');
        if (activeDev) switchTab('home');
        // Re-render tweaks to hide dev-only Settings buttons
        renderTweaks();
      });
    })();

    // ---------- ambient audio (enable-first) ----------
    (function setupAmbientAudio() {
      const audio = document.getElementById('bgAudio');
      const ctaBtn = document.getElementById('audioToggleBtn');
      if (ctaBtn) {
        ctaBtn.addEventListener('click', () => {
          if (!isMusicEnabled()) {
            setMusicEnabled(true);
          } else {
            requestMusicPlayback();
          }
        });
      }
      if (!audio) return;
      audioElement = audio;
      const src = encodeURI('assets/test 104.mp3');
      audio.src = src;
      audio.loop = true;
      audio.volume = 0.8;
      audio.addEventListener('play', () => syncMusicUI());
      audio.addEventListener('pause', () => syncMusicUI());
      if (pendingMusicPlayback || isMusicEnabled()) {
        requestMusicPlayback();
      }
    })();

    // ---------- Color utilities for tweak background brightness inversion (dark mode only) ----------
    function isDarkMode() {
      return document.documentElement.classList.contains('dark');
    }

    function parseHexColor(hex) {
      if (!hex) return { r: 255, g: 255, b: 255, a: 1 };
      hex = String(hex).trim();
      if (hex[0] === '#') hex = hex.slice(1);
      if (hex.length === 3) {
        const r = parseInt(hex[0] + hex[0], 16);
        const g = parseInt(hex[1] + hex[1], 16);
        const b = parseInt(hex[2] + hex[2], 16);
        return { r, g, b, a: 1 };
      }
      if (hex.length === 4) {
        const r = parseInt(hex[0] + hex[0], 16);
        const g = parseInt(hex[1] + hex[1], 16);
        const b = parseInt(hex[2] + hex[2], 16);
        const a = parseInt(hex[3] + hex[3], 16) / 255;
        return { r, g, b, a };
      }
      if (hex.length === 6 || hex.length === 8) {
        const r = parseInt(hex.slice(0, 2), 16);
        const g = parseInt(hex.slice(2, 4), 16);
        const b = parseInt(hex.slice(4, 6), 16);
        const a = hex.length === 8 ? parseInt(hex.slice(6, 8), 16) / 255 : 1;
        return { r, g, b, a };
      }
      // Not a hex; fallback by letting CSS handle it
      return null;
    }

    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max - min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      return { h, s, l };
    }

    function hslToRgb(h, s, l) {
      let r, g, b;
      if (s === 0) {
        r = g = b = l; // achromatic
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
    }

    function formatColor({ r, g, b, a }) {
      a = (a == null ? 1 : a);
      if (a >= 1) {
        const toHex = (n) => n.toString(16).padStart(2, '0');
        return '#' + toHex(r) + toHex(g) + toHex(b);
      }
      return `rgba(${r}, ${g}, ${b}, ${Math.round(a * 1000) / 1000})`;
    }

    function invertBrightnessColor(hex) {
      const rgba = parseHexColor(hex);
      if (!rgba) return hex; // unknown format, let CSS handle
      const { r, g, b, a } = rgba;
      const hsl = rgbToHsl(r, g, b);
      // Invert lightness and clamp to avoid pure black/white extremes
      const lInv = 1 - hsl.l;
      const lClamped = Math.min(0.92, Math.max(0.08, lInv));
      const { r: nr, g: ng, b: nb } = hslToRgb(hsl.h, hsl.s, lClamped);
      return formatColor({ r: nr, g: ng, b: nb, a });
    }

    function resolveTweakBg(bg) {
      // Only transform in dark mode; otherwise return as-is
      if (!isDarkMode()) return bg;
      try { return invertBrightnessColor(bg); } catch (e) { return bg; }
    }
    // -------- WormJB Mobile JavaScript Console (refactored external) --------
    function openConsole() {
      // Navigate to standalone console page for cleaner separation
      window.location.href = 'assets/console.html';
    }
    (function(){ const btn=document.getElementById('openConsoleBtn'); if(btn) btn.addEventListener('click', openConsole); })();
  </script>
</body>
</html>
