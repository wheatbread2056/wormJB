<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WormJB</title>
  <style>
    :root {
      --ios-blue: #007aff;
      --ios-gray: #f2f2f7;
      --ios-border: #c6c6c8;
      --ios-bg: #ffffff;
      --ios-text-gray: #555;
    }
    /* Dark variables are applied via early bootstrap/applyTheme; avoid CSS overrides leaking into light mode */
    html, body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--ios-bg);
      color: #000;
      height: 100%;
      overflow: hidden;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 56px; display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 1.2rem;
      border-bottom: 1px solid var(--ios-border);
      background: white; z-index: 10;
    }
    .version {
      position: fixed; top: 56px; width: 100%; text-align: center;
      font-size: 0.8rem; color: var(--ios-text-gray); background: white; padding: 0.3rem 0;
      z-index: 9;
    }
    main {
      position: absolute; top: 84px; bottom: 60px; left: 0; right: 0;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      background: var(--ios-bg);
      padding: 1rem; box-sizing: border-box;
    }
    section { display: none; }
    section.active { display: block; }

    .ios-card {
      background: white; border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 1rem; margin: 1rem 0;
    }
    .ios-list {
      background: white; border-radius: 12px;
      overflow: hidden; border: 1px solid var(--ios-border);
    }
    .ios-list-item {
      padding: 1rem; border-bottom: 1px solid var(--ios-border);
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1rem;
    }
    .ios-list-item:last-child { border-bottom: none; }
    .ios-button {
      background: var(--ios-blue); color: white; border: none;
      border-radius: 12px; font-size: 1rem; padding: 0.7rem 1.5rem;
      font-weight: 500; cursor: pointer; transition: opacity 0.2s;
    }
    .ios-button:active { opacity: 0.6; }
    .ios-button.danger { background: #ff3b30; }
    .ios-input {
      border: 1px solid var(--ios-border);
      border-radius: 12px; padding: 0.6rem 1rem;
      font-size: 1rem; width: 100%;
      background: var(--ios-gray); box-sizing: border-box;
      margin: 0.5rem 0;
    }
    .ios-switch { position: relative; width: 50px; height: 28px; }
    .ios-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; border-radius: 34px; transition: .3s;
    }
    .slider:before {
      position: absolute; content: "";
      height: 22px; width: 22px; left: 3px; bottom: 3px;
      background-color: white; border-radius: 50%; transition: .3s;
    }
    .ios-switch input:checked + .slider { background-color: var(--ios-blue); }
    .ios-switch input:checked + .slider:before { transform: translateX(22px); }
    .ios-alert {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; border-radius: 14px; padding: 1.2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center; display: none; width: 80%; max-width: 320px;
    }
    /* Dark mode for alerts/modals */
    html.dark .ios-alert { background: #111315; color: #e5e7eb; border: 1px solid var(--ios-border); }

    /* Scrollable tweak edit modal cleanup */
    #tweakModal { max-height: 80vh; width: 92vw; max-width: 420px; display: none; padding: 0; overflow: hidden; }
    #tweakModal h3 { margin: 1rem 1rem 0.25rem 1rem; }
    #tweakModalBody { text-align: left; margin: 0; padding: 0 1rem 0.5rem 1rem; max-height: 58vh; overflow-y: auto; }
    #tweakModal .modal-actions { display:flex; gap:.5rem; margin: .75rem 1rem 1rem; justify-content:center; flex-wrap:wrap; }

    /* Preserve newlines in System Info */
    #sysInfo { white-space: pre-wrap; }

    /* Status colors */
    .status-row { display:flex; align-items:center; justify-content:space-between; padding: .5rem 1rem; border-top: 1px solid var(--ios-border); }
    .status-row:first-child { border-top: none; }
    .status-pill { font-weight:600; }
    .status-red { color: #ef4444; }
    .status-yellow { color: #eab308; }
    .status-green { color: #22c55e; }
    .status-magenta { color: #d946ef; }
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; border-top: 1px solid var(--ios-border);
      background: white; height: 60px; z-index: 10;
    }
    .tab {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--ios-text-gray); font-size: 0.7rem; cursor: pointer;
      user-select: none;
    }

    /* Add consistent gap between icon and label and allow top alignment when tabs are tall */
    .tab { gap: 6px; }
    .tabs.tall .tab { justify-content: flex-start; padding-top: 8px; }
    .tab.active { color: var(--ios-blue); }
  svg { width: 22px; height: 22px; margin-bottom: 2px; }

    /* Tweak list layout stability */
    .tweak-left {
      display: flex; flex-direction: column; flex: 1 1 auto; min-width: 0; /* allow ellipsis */
    }
    .tweak-title-row { display:flex; align-items:center; gap:.5rem; min-width:0; }
    .tweak-name { font-size:1rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tweak-id { color: var(--ios-text-gray); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:40vw; }
  .tweak-desc { color: var(--ios-text-gray); margin-top:0.25rem; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; }
    .tweak-meta { color: var(--ios-text-gray); font-size:0.85rem; margin-top:0.35rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Header username color uses variable for proper dark/light contrast */
    #headerUsername { color: var(--ios-text-gray); }
    .tweak-right { display:flex; align-items:center; gap:.5rem; flex: 0 0 auto; }

  /* Version pill next to title */
  .version-pill { border: 1px solid var(--ios-border); color: var(--ios-text-gray); border-radius: 9999px; padding: 0.05rem 0.5rem; font-size: 0.8rem; font-weight: 500; }
  .ios-button.magenta { background: #d946ef; }
  .tabs.tall { height: 80px; }
  /* When tabs are tall, give main extra bottom spacing; applied via JS */

    /* When forcing Apple-like font (Inter) */
    html.force-apple-font, html.force-apple-font body {
      font-family: 'Inter', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
  </style>
  <!-- Early theme bootstrap to avoid flash and ensure variables are set before paint -->
  <script>
    (function(){
      try {
        var mode = localStorage.getItem('themeMode') || 'system';
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var dark = (mode === 'dark') || (mode === 'system' && prefersDark);
        if (dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
        var customBg = localStorage.getItem('customBg') || '';
        var bg = customBg || (dark ? '#0b0b0d' : '#ffffff');
        var border = dark ? '#2a2d34' : '#c6c6c8';
        var textGray = dark ? '#a1a1aa' : '#555';
        document.documentElement.style.setProperty('--ios-bg', bg);
        document.documentElement.style.setProperty('--ios-border', border);
        document.documentElement.style.setProperty('--ios-text-gray', textGray);
      } catch(e) {}
    })();
  </script>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between; padding:0 1rem;">
    <div style="display:flex; align-items:center; gap:.5rem;">
      <span style="font-weight:600; font-size:1.2rem;">WormJB</span>
      <span id="appVersion" class="version-pill">BETA</span>
    </div>
    <div id="headerProfileWrap" style="display:flex; align-items:center; gap:.5rem;">
  <span id="headerUsername" style="color: var(--ios-text-gray); font-size:0.95rem;">WormJB User</span>
      <!-- Profile button/icon. In Icon Mode this will be shown as an unstyled icon button; in Button Mode it will have .ios-button styling and include the username label inside the button -->
      <button id="profileBtn" class="ios-button" style="padding:0.3rem 0.6rem; display:flex; align-items:center; gap:.5rem;">
        <img id="profileIcon" src="assets/wormjbicon.png" alt="icon" style="width:20px; height:20px; border-radius:4px;" />
        <span id="profileBtnLabel" style="font-size:0.9rem;">Profile</span>
      </button>
    </div>
  </header>
  

  <main>
    <section id="home" class="active">
      <div class="ios-card">
  <h3 id="welcomeTitle">Welcome, WormJB User</h3>

        <!-- Compact action buttons (no extra titles) -->
        <div class="ios-list" style="margin-top:0.5rem;">
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button danger" id="removeJBBtn" style="width:100%;">Remove Jailbreak</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="installSideStoreBtn" style="width:100%;">Install SideStore</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="openRepoBtn" style="width:100%;">Open GitHub Repo</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="showScriptBtn" style="width:100%;">Show Script</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="openTerminalBtn" style="width:100%;">Open Terminal (A-Shell)</button>
          </div>
          <div class="ios-list-item" style="padding:.6rem;">
            <button class="ios-button" id="mysteryBtn" style="width:100%;">Do Nothing</button>
          </div>
        </div>

        <div style="margin-top:.75rem; display:flex; gap:.5rem; align-items:center;">
          <button class="ios-button magenta" id="audioToggleBtn">Play Looping Audio</button>
          <span style="color: var(--ios-text-gray); font-size:0.9rem;">Looping: <strong id="audioState">off</strong></span>
        </div>
      </div>
      <div class="ios-card">
        <h3>Status Report</h3>
        <div class="ios-list">
          <div class="status-row"><span>Sandboxed</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>PPL</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>SPTM</span><span class="status-pill status-red">False</span></div>
          <div class="status-row"><span>Environment</span><span class="status-pill status-yellow">Semi-Rootless</span></div>
          <div class="status-row"><span>SEP</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>WormJB</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>Root Access</span><span class="status-pill status-green">True</span></div>
          <div class="status-row"><span>Made with</span><span class="status-pill status-magenta">love</span></div>
        </div>
        <div style="display:flex; justify-content:center; margin-top:.75rem;">
          <button class="ios-button" id="copyHashBtn">Copy WormJB Device Hash</button>
        </div>
      </div>
    </section>

    <section id="tweaks">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; gap:.5rem;">
  <button id="browserBtn" class="ios-button">Browser</button>
  <button id="addTweakBtn" class="ios-button">Add Tweak</button>
      </div>
      <div id="tweak-container" class="ios-list" style="padding:0;">
        <!-- Tweaks will be rendered here by JS -->
      </div>

      <!-- Tweak edit modal (dev only) -->
      <div id="tweakModal" class="ios-alert" style="display:none;">
        <h3>Edit Tweak</h3>
        <div id="tweakModalBody" style="text-align:left; margin-top:.5rem;">
          <label>Name</label>
          <input id="tweakName" class="ios-input" />
          <label>ID</label>
          <input id="tweakId" class="ios-input" />
          <label>Description</label>
          <input id="tweakDesc" class="ios-input" />
          <label>Author</label>
          <input id="tweakAuthor" class="ios-input" />
          <label>Version</label>
          <input id="tweakVersion" class="ios-input" />
          <label>Date</label>
          <input id="tweakDate" class="ios-input" />
          <label>Background Color</label>
          <input id="tweakBg" class="ios-input" placeholder="#ffffff" />
          <hr style="border:none; border-top:1px solid var(--ios-border); margin:.75rem 0;" />
          <label>onEnable (JS code)</label>
          <textarea id="tweakOnEnable" class="ios-input" style="min-height:72px"></textarea>
          <label>Enable Confirmation Prompt</label>
          <input id="tweakEnablePrompt" class="ios-input" placeholder="Are you sure you want to enable?" />
          <label>Disable Confirmation Prompt</label>
          <input id="tweakDisablePrompt" class="ios-input" placeholder="Are you sure you want to disable?" />
        </div>
        <div class="modal-actions" style="display:flex; gap:.5rem; margin-top: .75rem; justify-content:center; flex-wrap:wrap;">
          <button class="ios-button" id="saveTweakBtn">Save</button>
          <button class="ios-button danger" id="deleteTweakBtn">Delete</button>
          <button class="ios-button" onclick="hideAlert()">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Tweak Browser page -->
    <section id="tweakBrowser">
      <div class="ios-card">
        <h3>Tweak Browser</h3>
        <div class="ios-list" id="repoList" style="padding:0;"></div>
        <div style="display:flex; justify-content:center; gap:.5rem; margin-top:.75rem;">
          <button class="ios-button" id="backFromBrowserBtn">Back</button>
        </div>
      </div>
    </section>

    <!-- Profile page (hidden until opened) -->
    <section id="profile">
      <div class="ios-card">
        <h3>Profile</h3>
        <div class="ios-list" style="padding:0;">
          <div class="ios-list-item" style="align-items:center; gap:0.75rem;">
            <img id="profileIconLarge" src="assets/wormjbicon.png" style="width:64px; height:64px; border-radius:12px;" />
            <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
                <div style="flex:1;">
                  <label style="display:block; font-size:0.85rem; margin-bottom:0.25rem;">Username</label>
                  <input id="profileUsername" class="ios-input" />
                </div>
              </div>
            </div>
          </div>

          <div class="ios-list-item" style="display:flex; flex-direction:column; gap:0.35rem;">
            <div style="display:flex; gap:0.75rem; align-items:center;">
              <span style="font-weight:600;">Display Mode</span>
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center;">
              <label style="display:flex; gap:.4rem; align-items:center;"><input type="radio" name="profileMode" value="icon" id="modeIcon"> Icon Mode</label>
              <label style="display:flex; gap:.4rem; align-items:center;"><input type="radio" name="profileMode" value="button" id="modeButton"> Button Mode</label>
            </div>
          </div>

          <div class="ios-list-item" style="flex-direction:column; gap:0.35rem; align-items:flex-start;">
            <div style="display:flex; width:100%; justify-content:space-between; align-items:center;">
              <div>
                <label style="display:block; font-size:0.85rem; margin-bottom:0.25rem;">Profile Icon Image</label>
                <input id="profileIconFile" type="file" accept="image/*" class="ios-input" style="padding:.4rem; width:220px;" />
                <div style="margin-top:0.35rem; color: var(--ios-text-gray); font-size:0.85rem;">Image stays local in your browser. Nothing is uploaded.</div>
              </div>
            </div>
          </div>

          <div class="ios-list-item" style="display:flex; gap:.5rem; justify-content:center;">
            <button class="ios-button" id="saveProfileBtn">Save</button>
            <button class="ios-button" id="closeProfileBtn">Close</button>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="ios-card">
        <h3>Settings</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Enable Logs</span>
            <label class="ios-switch">
              <input type="checkbox"><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item">
            <span>Auto-update</span>
            <label class="ios-switch">
              <input type="checkbox" checked><span class="slider"></span>
            </label>
          </div>
          <div class="ios-list-item" onclick="promptDebugCode()">
            <span style="color: var(--ios-blue);">Debug</span>
          </div>
        </div>
      </div>
      <div class="ios-card">
        <h3>Appearance</h3>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Theme</span>
            <select id="themeModeSelect" class="ios-input" style="width:auto;">
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="ios-list-item">
            <span>Custom Background</span>
            <input type="color" id="customBgColor" class="ios-input" style="width:64px; padding:0;">
            <button class="ios-button" id="resetBgBtn" style="margin-left:.5rem;">Reset</button>
          </div>
          <div class="ios-list-item" style="flex-direction:column; align-items:flex-start; gap:.35rem;">
            <div style="display:flex; align-items:center; gap:.5rem; width:100%; justify-content:space-between;">
              <span>Font</span>
              <div style="display:flex; align-items:center; gap:.5rem;">
                <select id="themeFontSelect" class="ios-input" style="width:120px;">
                  <option value="system">System</option>
                  <option value="inter">Inter</option>
                  <option value="other">Other...</option>
                </select>
                <input id="themeFontOther" class="ios-input" placeholder="Font-family (e.g. 'Roboto')" style="display:none; width:160px;" />
              </div>
            </div>
            <div style="display:flex; gap:.75rem; align-items:center; width:100%;">
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <span style="font-size:0.95rem;">Disable Music</span>
                <label class="ios-switch"><input type="checkbox" id="musicDisableToggle"><span class="slider"></span></label>
              </div>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <span style="font-size:0.95rem;">Tall Tabs (notched)</span>
                <label class="ios-switch"><input type="checkbox" id="tabsNotchToggle"><span class="slider"></span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="ios-card">
        <h3>System Info</h3>
        <div class="ios-list" id="sysInfo" style="padding:1rem; font-family:monospace; font-size:0.9rem;"></div>
      </div>
      <div class="ios-card">
        <h3>Credits</h3>
        <div class="ios-list" style="padding:1rem; line-height:1.5;">
          <div><strong>Founder:</strong> wheatbread2056 aka brainworm</div>
          <div><strong>Lead Developer:</strong> GPT-5 by OpenAI</div>
          <div><strong>Developer:</strong> wheatbread2056</div>
          <div><strong>Inspiration:</strong> cydia gold edition team</div>
          <div><strong>License:</strong> No license because nobody needs licenses.</div>
        </div>
      </div>
    </section>

    <section id="devsettings">
      <div class="ios-card">
        <h3>Developer Settings</h3>
        <p style="color: var(--ios-text-gray)">You’ve unlocked the dev menu.</p>
        <div class="ios-list">
          <div class="ios-list-item">
            <span>Verbose Logs</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Experimental Mode</span>
            <label class="ios-switch"><input type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="ios-list-item">
            <span>Force Apple Font (Web)</span>
            <label class="ios-switch">
              <input type="checkbox" id="forceAppleFontToggle"><span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: .75rem; flex-wrap:wrap;">
          <button class="ios-button danger" onclick="clearAppData()">Clear App Data & Reload</button>
          <button class="ios-button" id="disableDevBtn">Disable Dev Mode</button>
          <button class="ios-button" id="reloadAppBtn">Reload App</button>
          <button class="ios-button" id="exportDataBtn">Export Data (.wormdata)</button>
          <input id="importDataInput" type="file" accept=".wormdata,application/json" style="display:none;" />
          <button class="ios-button" id="importDataBtn">Import Data (.wormdata)</button>
        </div>
      </div>
    </section>
  </main>

  <div id="alert" class="ios-alert">
    <h3>WormJB</h3>
    <p id="alert-text">Placeholder text</p>
    <button class="ios-button" onclick="hideAlert()">OK</button>
  </div>

  <!-- Background audio (loop) -->
  <audio id="bgAudio" preload="auto"></audio>

  <nav class="tabs" id="tab-bar">
    <div class="tab" data-tab="tweaks">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-5"/><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      <span>Tweaks</span>
    </div>
    <div class="tab active" data-tab="home">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/></svg>
      <span>Home</span>
    </div>
    <div class="tab" data-tab="settings">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 5.6a1.65 1.65 0 0 0 1-1.51V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span>Settings</span>
    </div>
  </nav>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('section');
    const tabBar = document.getElementById('tab-bar');

    function switchTab(target) {
      // Use fresh queries so dynamically added tabs (Dev) are handled
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.tab[data-tab="${target}"]`);
      if (tab) tab.classList.add('active');
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      const section = document.getElementById(target);
      if (section) section.classList.add('active');
    }

    tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

    function showAlert(msg) {
      const alertBox = document.getElementById('alert');
      document.getElementById('alert-text').textContent = msg;
      alertBox.style.display = 'block';
    }
    function hideAlert() {
      document.getElementById('alert').style.display = 'none';
    }

    function promptDebugCode() {
      const unlocked = localStorage.getItem('devUnlocked');
      if (unlocked === 'true') {
        showDevTab();
        switchTab('devsettings');
        return;
      }
      const code = prompt('Enter debug code:');
      if (code === 'brainworm') {
        localStorage.setItem('devUnlocked', 'true');
        showDevTab();
        switchTab('devsettings');
      }
    }

    function showDevTab() {
      if (!document.querySelector('.tab[data-tab=\"devsettings\"]')) {
        const devTab = document.createElement('div');
        devTab.className = 'tab';
        devTab.dataset.tab = 'devsettings';
        devTab.innerHTML = `
          <svg fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" viewBox=\"0 0 24 24\"><path d=\"M9 18l6-6-6-6\"/></svg>
          <span>Dev</span>`;
        devTab.addEventListener('click', () => switchTab('devsettings'));
        tabBar.appendChild(devTab);
      }
    }

    if (localStorage.getItem('devUnlocked') === 'true') {
      showDevTab();
    }

    // Font forcing (Apple-like font using Inter from web)
    const FORCE_FONT_KEY = 'forceAppleFont';

    function ensureInterLoaded() {
      if (document.getElementById('interFontLink')) return;
      const link = document.createElement('link');
      link.id = 'interFontLink';
      link.rel = 'stylesheet';
      link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap';
      document.head.appendChild(link);
    }

    function setForceAppleFont(enabled) {
      localStorage.setItem(FORCE_FONT_KEY, enabled ? 'true' : 'false');
      if (enabled) {
        ensureInterLoaded();
        document.documentElement.classList.add('force-apple-font');
      } else {
        document.documentElement.classList.remove('force-apple-font');
      }
      const cb = document.getElementById('forceAppleFontToggle');
      if (cb) cb.checked = !!enabled;
    }

    // Initialize state from storage
    if (localStorage.getItem(FORCE_FONT_KEY) === 'true') {
      setForceAppleFont(true);
    }

    // Wire toggle if present
    (function attachFontToggle() {
      const cb = document.getElementById('forceAppleFontToggle');
      if (!cb) return;
      cb.checked = localStorage.getItem(FORCE_FONT_KEY) === 'true';
      cb.addEventListener('change', (e) => setForceAppleFont(e.target.checked));
    })();

    // ---------- Tweaks rendering and persistence ----------
    const TWEAKS_KEY = 'wormjb_tweaks_v1';

    function defaultTweaks() {
      return [
        { id: 'tweak.wormjb.hookworm', name: 'Hookworm', description: 'The WormJB tweak loader', author: 'wormjb', version: '1.0', date: '2025-11-11', bg: '#f7b2f0', enabled: true },
        { id: 'tweak.pissrain.respring', name: 'Respring Support', description: 'Respring support for wormJB', author: 'Pissra1n tweak devs', version: '0.3.1', date: '2025-06-12', bg: '#b9f7b2', enabled: true },
        { id: 'app.sileo.demo', name: 'Sileo Demo', description: 'Sileo Demo ipa installer', version: '0.8b11', author: 'Sileo Team', date: '2025-10-30', bg: '#9fe8f2', enabled: false, onEnable: "window.open('https://raw.githubusercontent.com/wheatbread2056/wormjbrepo/main/Sileo_Demo_0.8b11.ipa', '_blank');" }
      ];
    }

    function loadTweaks() {
      try {
        const raw = localStorage.getItem(TWEAKS_KEY);
        if (!raw) return defaultTweaks();
        return JSON.parse(raw);
      } catch (e) { return defaultTweaks(); }
    }

    function saveTweaks(tweaks) {
      localStorage.setItem(TWEAKS_KEY, JSON.stringify(tweaks));
    }

    function renderTweaks() {
      const container = document.getElementById('tweak-container');
      const tweaks = loadTweaks();
      container.innerHTML = '';
      tweaks.forEach((t, idx) => {
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.style.display = 'flex';
        item.style.flexDirection = 'row';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.background = resolveTweakBg(t.bg || 'white');
        item.style.borderBottom = '1px solid var(--ios-border)';
        item.style.padding = '0.75rem';

        const left = document.createElement('div');
        left.className = 'tweak-left';
        left.style.marginRight = '0.75rem';
        left.innerHTML = `
          <div class="tweak-title-row">
            <strong class="tweak-name">${escapeHtml(t.name)}</strong>
            <small class="tweak-id">${escapeHtml(t.id)}</small>
          </div>
          <div class="tweak-desc">${escapeHtml(t.description)}</div>
          <div class="tweak-meta">By ${escapeHtml(t.author)} • v${escapeHtml(t.version)} • ${escapeHtml(t.date)}</div>
        `;

  const right = document.createElement('div');
  right.className = 'tweak-right';

        const label = document.createElement('label');
        label.className = 'ios-switch';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!t.enabled;
        const span = document.createElement('span');
        span.className = 'slider';
        label.appendChild(checkbox);
        label.appendChild(span);

        checkbox.addEventListener('change', () => {
          const ts = loadTweaks();
          const tw = ts[idx];
          const goingEnabled = checkbox.checked;
          let proceed = true;
          const msg = goingEnabled ? tw.enableConfirmationPrompt : tw.disableConfirmationPrompt;
          if (msg && typeof msg === 'string' && msg.trim()) {
            proceed = confirm(msg);
          }
          if (!proceed) {
            checkbox.checked = !goingEnabled;
            return;
          }
          tw.enabled = goingEnabled;
          saveTweaks(ts);
          if (goingEnabled && tw.onEnable && tw.onEnable.trim()) {
            try {
              // Run in isolated function scope
              new Function(tw.onEnable)();
            } catch (e) {
              console.error('onEnable error:', e);
              showAlert('onEnable error: ' + (e && e.message ? e.message : e));
            }
          }
        });

        right.appendChild(label);

        // If dev unlocked, show settings button
        if (localStorage.getItem('devUnlocked') === 'true') {
          const settingsBtn = document.createElement('button');
          settingsBtn.className = 'ios-button';
          settingsBtn.textContent = 'Settings';
          settingsBtn.style.padding = '0.4rem 0.6rem';
          settingsBtn.addEventListener('click', () => openTweakEditor(idx));
          right.appendChild(settingsBtn);
        }

        item.appendChild(left);
        item.appendChild(right);
        container.appendChild(item);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Tweak editor modal
    let currentEditIndex = null;
    function openTweakEditor(idx) {
      const tweaks = loadTweaks();
      const t = tweaks[idx];
      if (!t) return;
      currentEditIndex = idx;
      document.getElementById('tweakName').value = t.name || '';
      document.getElementById('tweakId').value = t.id || '';
      document.getElementById('tweakDesc').value = t.description || '';
      document.getElementById('tweakAuthor').value = t.author || '';
      document.getElementById('tweakVersion').value = t.version || '';
      document.getElementById('tweakDate').value = t.date || '';
      document.getElementById('tweakBg').value = t.bg || '';
      document.getElementById('tweakOnEnable').value = t.onEnable || '';
      document.getElementById('tweakEnablePrompt').value = t.enableConfirmationPrompt || '';
      document.getElementById('tweakDisablePrompt').value = t.disableConfirmationPrompt || '';
      const modal = document.getElementById('tweakModal');
      modal.style.display = 'block';
    }

    document.getElementById('saveTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      if (currentEditIndex === null) return hideAlert();
      tweaks[currentEditIndex] = {
        id: document.getElementById('tweakId').value,
        name: document.getElementById('tweakName').value,
        description: document.getElementById('tweakDesc').value,
        author: document.getElementById('tweakAuthor').value,
        version: document.getElementById('tweakVersion').value,
        date: document.getElementById('tweakDate').value,
        bg: document.getElementById('tweakBg').value,
        enabled: tweaks[currentEditIndex].enabled,
        onEnable: document.getElementById('tweakOnEnable').value,
        enableConfirmationPrompt: document.getElementById('tweakEnablePrompt').value,
        disableConfirmationPrompt: document.getElementById('tweakDisablePrompt').value
      };
      saveTweaks(tweaks);
      hideAlert();
      renderTweaks();
    });

    const deleteBtn = document.getElementById('deleteTweakBtn');
    if (deleteBtn) deleteBtn.addEventListener('click', () => {
      const tweaks = loadTweaks();
      if (currentEditIndex === null) return hideAlert();
      tweaks.splice(currentEditIndex, 1);
      saveTweaks(tweaks);
      currentEditIndex = null;
      hideAlert();
      renderTweaks();
    });

    // Override hideAlert to hide modal too
    const originalHide = hideAlert;
    function hideAlert() {
      const modal = document.getElementById('tweakModal');
      if (modal) modal.style.display = 'none';
      const alertBox = document.getElementById('alert');
      if (alertBox) alertBox.style.display = 'none';
    }

  // Show alert remains same but ensure modal can be reused
  // render initially
  renderTweaks();

    // ---------- Profile management and Add Tweak ----------
    const PROFILE_KEY = 'wormjb_profile_v1';

    function loadProfile() {
      try { return JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}'); } catch (e) { return {}; }
    }

    function saveProfile(p) { localStorage.setItem(PROFILE_KEY, JSON.stringify(p || {})); }

    function applyProfileToHeader() {
      const p = loadProfile();
      const name = p.username || 'WormJB User';
      const icon = p.icon || 'assets/wormjbicon.png';
      const mode = p.displayMode || 'icon';

      // Header username (left-side). Only shown in Icon Mode; hidden in Button Mode.
      const headerUsernameEl = document.getElementById('headerUsername');
      if (headerUsernameEl) headerUsernameEl.textContent = name;

      // Profile icon elements
      const img = document.getElementById('profileIcon');
      const imgLarge = document.getElementById('profileIconLarge');
      if (img) img.src = icon;
      if (imgLarge) imgLarge.src = icon;

  // Use username as tooltip on the icon/button
  const wrap = document.getElementById('headerProfileWrap');
  if (wrap) wrap.title = name;

      // Set the button label inside the profile button (used in Button Mode)
      const btnLabel = document.getElementById('profileBtnLabel');
      if (btnLabel) btnLabel.textContent = name;

      // Reflect mode in header rendering
      renderProfileDisplayMode(mode);

      // populate profile fields in profile panel
      const inputUser = document.getElementById('profileUsername');
      const modeIcon = document.getElementById('modeIcon');
      const modeButton = document.getElementById('modeButton');
      if (inputUser) inputUser.value = p.username || '';
      if (modeIcon) modeIcon.checked = (mode === 'icon');
      if (modeButton) modeButton.checked = (mode === 'button');
    }

    function renderProfileDisplayMode(mode) {
      const headerUsernameEl = document.getElementById('headerUsername');
      const profileBtn = document.getElementById('profileBtn');
      const profileIcon = document.getElementById('profileIcon');
      const profileBtnLabel = document.getElementById('profileBtnLabel');
      if (!profileBtn || !profileIcon) return;

      if (mode === 'button') {
        // Button Mode: hide left username, style the profile as a button with icon + username inside
        if (headerUsernameEl) headerUsernameEl.style.display = 'none';
        // Clear any icon-mode inline styles that could suppress button look
        profileBtn.style.background = '';
        profileBtn.style.border = '';
        profileBtn.classList.add('ios-button');
        profileBtn.style.padding = '0.3rem 0.6rem';
        profileBtnLabel.style.display = 'inline';
        // ensure aria/tooltip shows fullname via parent title
        profileBtn.setAttribute('aria-label', profileBtnLabel.textContent || 'Profile');
      } else {
        // Icon Mode: show username to the left, render the icon as an unstyled icon button
        if (headerUsernameEl) headerUsernameEl.style.display = 'inline-block';
        profileBtn.classList.remove('ios-button');
        profileBtn.style.padding = '0';
        profileBtnLabel.style.display = 'none';
        profileBtn.style.background = 'transparent';
        profileBtn.style.border = 'none';
      }

      // Ensure the icon image remains clickable but visually appropriate
      profileIcon.style.width = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.height = (mode === 'button') ? '20px' : '26px';
      profileIcon.style.borderRadius = '4px';
    }

    document.getElementById('profileBtn').addEventListener('click', () => {
      // Open real Profile page as a section/tab
      switchTab('profile');
      applyProfileToHeader();
    });

    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      switchTab('home');
    });

    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      const mode = (document.getElementById('modeButton') && document.getElementById('modeButton').checked) ? 'button' : 'icon';
      const p = {
        username: document.getElementById('profileUsername').value,
        // Keep any previously saved icon (uploads are handled elsewhere), fallback to default
        icon: (loadProfile().icon) || 'assets/wormjbicon.png',
        displayMode: mode
      };
      saveProfile(p);
      applyProfileToHeader();
      showAlert('Profile saved');
    });

    // Live preview when switching display mode in profile panel
    const modeIconRadio = document.getElementById('modeIcon');
    const modeButtonRadio = document.getElementById('modeButton');
    if (modeIconRadio) modeIconRadio.addEventListener('change', () => { if (modeIconRadio.checked) renderProfileDisplayMode('icon'); });
    if (modeButtonRadio) modeButtonRadio.addEventListener('change', () => { if (modeButtonRadio.checked) renderProfileDisplayMode('button'); });

    // Dev UI updates that depend on devUnlocked (no longer hide Add Tweak)
    function updateDevUI() {
      // currently nothing to toggle besides dev-only content in tweaks (renderTweaks handles that)
    }

    document.getElementById('addTweakBtn').addEventListener('click', () => {
      const tweaks = loadTweaks();
      const newT = { id: 'tweak.' + Date.now(), name: 'New Tweak', description: '', author: '', version: '0.1', date: new Date().toISOString().slice(0,10), bg: '#ffffff', enabled: false };
      tweaks.unshift(newT);
      saveTweaks(tweaks);
      renderTweaks();
      // open editor for the new tweak (index 0)
      openTweakEditor(0);
    });

    // Browser data: varied tweaks (naming conventions, versions, dates) and some apps
    function slugifyName(n){
      return String(n).toLowerCase().replace(/[^a-z0-9]+/g,'').trim();
    }
    const REPO_ITEMS = [
      // Tweaks
      { type:'tweak', name:'AeroDock', desc:'Sleek dock transparency for Home Screen.', ver:'1.0.0', date:'2025-01-15', author:'azuki', bg:'#eef7ff' },
      { type:'tweak', name:'ClearBadge+', desc:'Clear badges with a pull gesture.', ver:'1.2.3', date:'2025-02-01', author:'mara', bg:'#fef3c7' },
      { type:'tweak', name:'StatusFlex 2', desc:'Customize status bar elements.', ver:'2.0.0', date:'2025-02-20', author:'luke', bg:'#f3f4f6' },
      { type:'tweak', name:'Night Owl (Beta)', desc:'True system-wide dark enhancement.', ver:'0.9.0-beta', date:'2025-03-05', author:'nero', bg:'#1118270d' },
      { type:'tweak', name:'QuickSettings Pro', desc:'Fast toggles in Control Center.', ver:'3.1.4', date:'2025-03-22', author:'olive', bg:'#ecfccb' },
      { type:'tweak', name:'LiveBattery Ring', desc:'Live battery ring on icons.', ver:'1.0.5', date:'2025-04-10', author:'finn', bg:'#f5f3ff' },
      { type:'tweak', name:'SnapGrid', desc:'Snap icons to a neat grid.', ver:'1.3.0', date:'2025-04-28', author:'kai', bg:'#e0f2fe' },
      { type:'tweak', name:'SilentTap', desc:'Silence camera shutter with a tap.', ver:'0.9.9', date:'2025-05-09', author:'zoe', bg:'#fef2f2' },
      { type:'tweak', name:'AppLocker', desc:'Passcode protect chosen apps.', ver:'2.4.1', date:'2025-05-21', author:'ian', bg:'#f3e8ff' },
      { type:'tweak', name:'UI Rounder', desc:'Round UI corners system-wide.', ver:'1.0', date:'2025-06-01', author:'xeno', bg:'#f0fdf4' },
      { type:'tweak', name:'EdgeSwipe', desc:'Gesture from edges to switch apps.', ver:'1.0.7', date:'2025-06-12', author:'vera', bg:'#fff7ed' },
      { type:'tweak', name:'HaptiTune', desc:'Fine-tune haptics feedback.', ver:'1.5.0', date:'2025-06-30', author:'noah', bg:'#f1f5f9' },
      { type:'tweak', name:'LockGlyph', desc:'Animated lock glyph on unlock.', ver:'1.2', date:'2025-07-08', author:'gale', bg:'#fef9c3' },
      { type:'tweak', name:'ScreenDimmer X', desc:'Auto-dim screen intelligently.', ver:'10.0', date:'2025-07-20', author:'ivy', bg:'#fafafa' },
      { type:'tweak', name:'IconWeaver', desc:'Weave custom icon overlays.', ver:'0.8.2', date:'2025-08-01', author:'sol', bg:'#ffe4e6' },
      { type:'tweak', name:'TintKit+', desc:'Global tint color control.', ver:'1.1.1', date:'2025-08-14', author:'tori', bg:'#fefce8' },
      { type:'tweak', name:'Music Bar Lite', desc:'Compact music bar on Home.', ver:'1.0.2', date:'2025-08-29', author:'milo', bg:'#eff6ff' },
      { type:'tweak', name:'PopupKill 2', desc:'Auto-close annoying popups.', ver:'2.0.3', date:'2025-09-09', author:'aria', bg:'#f0f9ff' },
      { type:'tweak', name:'ReachPlus', desc:'Extended reachability options.', ver:'3.0.0', date:'2025-09-20', author:'rhett', bg:'#f7fee7' },
      { type:'tweak', name:'QuietHours', desc:'Schedule silence times.', ver:'1.4.6', date:'2025-10-01', author:'yuna', bg:'#f8fafc' },
      { type:'tweak', name:'ShadowLess', desc:'Remove icon drop-shadows.', ver:'1.0', date:'2025-10-12', author:'zane', bg:'#f5f5f5' },
      { type:'tweak', name:'FolderArt', desc:'Custom images for folders.', ver:'0.4.0', date:'2025-10-18', author:'dina', bg:'#faf5ff' },
      { type:'tweak', name:'HUD Lite', desc:'Minimal volume HUD.', ver:'1.7.2', date:'2025-10-25', author:'quinn', bg:'#f0fdfa' },
      { type:'tweak', name:'Springy', desc:'Bouncy spring animations.', ver:'4.0.0', date:'2025-11-01', author:'brea', bg:'#fff1f2' },
      { type:'tweak', name:'BlurBoost', desc:'Sharper blur performance.', ver:'1.0.0', date:'2025-11-12', author:'lex', bg:'#f1f0ff' },
      // Extra tweaks
      { type:'tweak', name:'DockHider', desc:'Hide the dock until needed.', ver:'0.1.0', date:'2025-02-10', author:'azuki', bg:'#eef7ff' },
      { type:'tweak', name:'BadgeCounter Pro', desc:'Advanced badge counting.', ver:'1.8.9', date:'2025-03-17', author:'mara', bg:'#fef3c7' },
      { type:'tweak', name:'StatusGlyph', desc:'Icons in status bar.', ver:'0.6.4', date:'2025-04-04', author:'luke', bg:'#f3f4f6' },
      // Apps (do nothing; just listed)
      { type:'app', name:'FileVoyager', desc:'Powerful file browser.', ver:'2.3.0', date:'2025-06-06', author:'wormjb', bg:'#e0f2fe' },
      { type:'app', name:'TerminaLite', desc:'Lightweight terminal.', ver:'0.9.1', date:'2025-07-07', author:'wormjb', bg:'#f5f3ff' },
      { type:'app', name:'IconStudio', desc:'Design and export icons.', ver:'1.0.0', date:'2025-08-18', author:'wormjb', bg:'#f3e8ff' },
      { type:'app', name:'ThemeCraft', desc:'Build themes with ease.', ver:'1.2.0', date:'2025-09-22', author:'wormjb', bg:'#f0fdf4' }
    ];
    const DEFAULT_REPO = REPO_ITEMS.map(it => ({
      id: `${it.type === 'app' ? 'app' : 'tweak'}.${slugifyName(it.name)}`,
      name: it.name,
      description: it.desc,
      author: it.author,
      version: it.ver,
      date: it.date,
      bg: it.bg
    }));

    const repoList = document.getElementById('repoList');
    function renderRepo() {
      if (!repoList) return;
      repoList.innerHTML = '';
      DEFAULT_REPO.forEach((t) => {
        const row = document.createElement('div');
        row.className = 'ios-list-item';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.background = resolveTweakBg(t.bg || 'white');
        const left = document.createElement('div');
        left.className = 'tweak-left';
        left.innerHTML = `
          <div class="tweak-title-row"><strong class="tweak-name">${escapeHtml(t.name)}</strong><small class="tweak-id">${escapeHtml(t.id)}</small></div>
          <div class="tweak-desc">${escapeHtml(t.description)}</div>
          <div class="tweak-meta">By ${escapeHtml(t.author)} • v${escapeHtml(t.version)} • ${escapeHtml(t.date)}</div>
        `;
        const right = document.createElement('div');
        right.className = 'tweak-right';
        const installBtn = document.createElement('button');
        installBtn.className = 'ios-button';
        installBtn.textContent = 'Install';
        installBtn.addEventListener('click', () => {
          const tweaks = loadTweaks();
          // prevent duplicate by id
          if (tweaks.some(x=>x.id===t.id)) { showAlert('Already installed'); return; }
          tweaks.unshift({ ...t, enabled: false });
          saveTweaks(tweaks);
          showAlert('Installed '+t.name);
          renderTweaks();
        });
        right.appendChild(installBtn);
        row.appendChild(left);
        row.appendChild(right);
        repoList.appendChild(row);
      });
    }

    const browserBtn = document.getElementById('browserBtn');
    if (browserBtn) browserBtn.addEventListener('click', () => { renderRepo(); switchTab('tweakBrowser'); });
    const backFromBrowserBtn = document.getElementById('backFromBrowserBtn');
    if (backFromBrowserBtn) backFromBrowserBtn.addEventListener('click', () => switchTab('tweaks'));

    // System info rendering
    (function renderSystemInfo(){
      const el = document.getElementById('sysInfo');
      if (!el) return;
      const nav = navigator;
      const lines = [];
      lines.push('User Agent: ' + nav.userAgent);
      lines.push('Platform: ' + (nav.platform || ''));
      lines.push('Language: ' + (nav.language || ''));
      lines.push('Cores: ' + (nav.hardwareConcurrency || 'n/a'));
      lines.push('Memory: ' + ((nav.deviceMemory && (nav.deviceMemory+' GB')) || 'n/a'));
      lines.push('Screen: ' + screen.width + 'x' + screen.height + ' @' + (window.devicePixelRatio||1) + 'x');
      lines.push('Timezone: ' + Intl.DateTimeFormat().resolvedOptions().timeZone);
      el.textContent = lines.join('\n');
    })();

    // Import/Export data
    const exportBtn = document.getElementById('exportDataBtn');
    if (exportBtn) exportBtn.addEventListener('click', () => {
      const data = { localStorage: { ...localStorage } };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'wormjb.wormdata';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    const importBtn = document.getElementById('importDataBtn');
    const importInput = document.getElementById('importDataInput');
    if (importBtn && importInput) {
      importBtn.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', () => {
        const file = importInput.files && importInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (parsed && parsed.localStorage) {
              Object.keys(parsed.localStorage).forEach(k => {
                try { localStorage.setItem(k, parsed.localStorage[k]); } catch(e) {}
              });
              showAlert('Data imported. Reloading...');
              setTimeout(()=>location.reload(), 600);
            }
          } catch (e) {
            showAlert('Import failed: ' + (e && e.message ? e.message : e));
          }
        };
        reader.readAsText(file);
      });
    }

    // Theme handling (system/light/dark + custom bg + font override)
    const THEME_MODE_KEY = 'themeMode'; // system|light|dark
    const CUSTOM_BG_KEY = 'customBg';
    const FONT_OVERRIDE_KEY = 'themeFont';
  const THEME_FONT_CHOICE_KEY = 'themeFontChoice'; // system|inter|other
  const THEME_FONT_OTHER_KEY = 'themeFontOther';
  const MUSIC_DISABLED_KEY = 'musicDisabled';
  const TABS_NOTCH_KEY = 'tabsNotch';

    function applyTheme() {
      const mode = localStorage.getItem(THEME_MODE_KEY) || 'system';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = mode === 'dark' || (mode === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      const customBg = localStorage.getItem(CUSTOM_BG_KEY) || '';
      const bg = customBg || (dark ? '#0b0b0d' : '#ffffff');
      const border = dark ? '#2a2d34' : '#c6c6c8';
      const textGray = dark ? '#a1a1aa' : '#555';
      document.documentElement.style.setProperty('--ios-bg', bg);
      document.documentElement.style.setProperty('--ios-border', border);
      document.documentElement.style.setProperty('--ios-text-gray', textGray);
      // Font handling: system | inter | other
      const fontChoice = localStorage.getItem(THEME_FONT_CHOICE_KEY) || 'system';
      const fontOther = localStorage.getItem(THEME_FONT_OTHER_KEY) || '';
      const fontSelect = document.getElementById('themeFontSelect');
      const fontOtherInput = document.getElementById('themeFontOther');
      if (fontSelect) fontSelect.value = fontChoice;
      if (fontOtherInput) { fontOtherInput.value = fontOther; fontOtherInput.style.display = (fontChoice==='other') ? 'inline-block' : 'none'; }
      if (fontChoice === 'inter') { ensureInterLoaded(); document.documentElement.classList.add('force-apple-font'); document.documentElement.style.fontFamily = ''; }
      else if (fontChoice === 'other') { document.documentElement.classList.remove('force-apple-font'); document.documentElement.style.fontFamily = fontOther || ''; }
      else { document.documentElement.classList.remove('force-apple-font'); document.documentElement.style.fontFamily = ''; }
      // reflect selects
      const sel = document.getElementById('themeModeSelect');
      if (sel) sel.value = mode;
      const color = document.getElementById('customBgColor');
      if (color && customBg) color.value = customBg;
      // Re-render lists that depend on theme (for per-item bg transforms)
      try { renderTweaks(); } catch(e) {}
      try { renderRepo(); } catch(e) {}
      // Music disabled state
      const musicDisabled = localStorage.getItem(MUSIC_DISABLED_KEY) === 'true';
      const audioBtn = document.getElementById('audioToggleBtn');
      const audioEl = document.getElementById('bgAudio');
      if (audioBtn) audioBtn.style.display = musicDisabled ? 'none' : 'inline-block';
      if (audioEl && musicDisabled) { try{ audioEl.pause(); audioEl.src = ''; }catch(e){} }
      // Tabs notch handling
      const tabsNotch = localStorage.getItem(TABS_NOTCH_KEY);
      const enabledNotch = (tabsNotch === null ? 'true' : tabsNotch) === 'true';
      applyTabHeight(enabledNotch);
    }

    // Dark theme CSS variables (light/dark via .dark class)
    (function injectDarkCSS(){
      const style = document.createElement('style');
      style.textContent = `
        html.dark body { color: #fafafa; }
        /* Scope surface overrides to dark mode only */
        html.dark .ios-card, html.dark .ios-list { background: var(--ios-bg); border-color: var(--ios-border); }
        html.dark .ios-list-item { border-color: var(--ios-border); }
  html.dark header, html.dark .tabs { background: var(--ios-bg); border-color: var(--ios-border); color: var(--ios-text-gray); }
        /* Inputs/buttons get slight dark tweaks in dark mode */
        html.dark .ios-button { background: #2563eb; color: #fff; }
        html.dark .ios-button.danger { background: #ef4444; }
        html.dark .ios-input { background: #1a1d23; color: #e5e7eb; border-color: #2a2d34; }
        html.dark .slider { background-color: #333842; }
        html.dark .ios-switch input:checked + .slider { background-color: #2563eb; }
      `;
      document.head.appendChild(style);
    })();

  const themeSel = document.getElementById('themeModeSelect');
  const bgPicker = document.getElementById('customBgColor');
  const resetBgBtn = document.getElementById('resetBgBtn');
  const fontSelect = document.getElementById('themeFontSelect');
  const fontOtherInput = document.getElementById('themeFontOther');
  const musicToggle = document.getElementById('musicDisableToggle');
  const tabsNotchToggle = document.getElementById('tabsNotchToggle');
  if (themeSel) themeSel.addEventListener('change', ()=>{ localStorage.setItem(THEME_MODE_KEY, themeSel.value); applyTheme(); });
  if (bgPicker) bgPicker.addEventListener('input', ()=>{ localStorage.setItem(CUSTOM_BG_KEY, bgPicker.value || ''); applyTheme(); });
  if (resetBgBtn) resetBgBtn.addEventListener('click', ()=>{ localStorage.removeItem(CUSTOM_BG_KEY); if (bgPicker) bgPicker.value = '#ffffff'; applyTheme(); });
  if (fontSelect) fontSelect.addEventListener('change', ()=>{ localStorage.setItem(THEME_FONT_CHOICE_KEY, fontSelect.value); applyTheme(); });
  if (fontOtherInput) fontOtherInput.addEventListener('input', ()=>{ localStorage.setItem(THEME_FONT_OTHER_KEY, fontOtherInput.value || ''); applyTheme(); });
  if (musicToggle) { musicToggle.checked = localStorage.getItem(MUSIC_DISABLED_KEY) === 'true'; musicToggle.addEventListener('change', ()=>{ localStorage.setItem(MUSIC_DISABLED_KEY, musicToggle.checked ? 'true' : 'false'); applyTheme(); }); }
  if (tabsNotchToggle) { tabsNotchToggle.checked = (localStorage.getItem(TABS_NOTCH_KEY) === null) ? true : (localStorage.getItem(TABS_NOTCH_KEY) === 'true'); tabsNotchToggle.addEventListener('change', ()=>{ localStorage.setItem(TABS_NOTCH_KEY, tabsNotchToggle.checked ? 'true' : 'false'); applyTabHeight(tabsNotchToggle.checked); }); }

    // Follow system changes when in system mode
    if (window.matchMedia) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', () => applyTheme());
    }

    // Reload button
    const reloadBtn = document.getElementById('reloadAppBtn');
    if (reloadBtn) reloadBtn.addEventListener('click', ()=>location.reload());

    // Apply theme at startup
    applyTheme();

    // Adjust tab height and main bottom spacing
    function applyTabHeight(enabled) {
      const tabBarEl = document.getElementById('tab-bar');
      const mainEl = document.querySelector('main');
      if (!tabBarEl || !mainEl) return;
      if (enabled) {
        tabBarEl.classList.add('tall');
        mainEl.style.bottom = '90px';
      } else {
        tabBarEl.classList.remove('tall');
        mainEl.style.bottom = '60px';
      }
    }

    // Local image upload for profile icon (stored as data URL in localStorage)
    (function setupProfileIconUpload() {
      const fileInput = document.getElementById('profileIconFile');
      if (!fileInput) return;
      fileInput.addEventListener('change', () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          const p = loadProfile();
          p.icon = dataUrl;
          saveProfile(p);
          applyProfileToHeader();
        };
        reader.readAsDataURL(file);
      });
    })();

    // apply profile & dev UI initially
    applyProfileToHeader();
    updateDevUI();

    // Update welcome title whenever profile applied
    function updateWelcomeTitle() {
      const p = loadProfile();
      const name = p.username || 'WormJB User';
      const el = document.getElementById('welcomeTitle');
      if (el) el.textContent = 'Welcome, ' + name;
    }
    updateWelcomeTitle();

    async function clearAppData() {
      const confirmClear = confirm('This will clear all saved data for this app (settings, caches, cookies) and reload. Dev menu will be locked again. Continue?');
      if (!confirmClear) return;

      try {
        // Ensure dev menu will be locked on next load
        try { localStorage.removeItem('devUnlocked'); } catch (e) {}

        // Local/session storage
        try { localStorage.clear(); } catch (e) {}
        try { sessionStorage.clear(); } catch (e) {}

        // IndexedDB (best-effort)
        try {
          if ('databases' in indexedDB && typeof indexedDB.databases === 'function') {
            const dbs = await indexedDB.databases();
            for (const db of dbs) {
              if (db && db.name) {
                try { indexedDB.deleteDatabase(db.name); } catch (e) {}
              }
            }
          }
        } catch (e) {}

        // Cache Storage
        try {
          if (window.caches && caches.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        } catch (e) {}

        // Service Workers
        try {
          if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
        } catch (e) {}

        // Cookies (best-effort for this origin)
        try {
          const cookies = document.cookie ? document.cookie.split(';') : [];
          for (const c of cookies) {
            const eqPos = c.indexOf('=');
            const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
            const expires = 'Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = `${name}=;expires=${expires};path=/`;
            // Attempt domain-scoped delete as well
            const host = location.hostname;
            document.cookie = `${name}=;expires=${expires};path=/;domain=${host}`;
            if (!host.startsWith('.')) {
              document.cookie = `${name}=;expires=${expires};path=/;domain=.${host}`;
            }
          }
        } catch (e) {}
      } finally {
        // Reload the page to reflect cleared state
        location.reload();
      }
    }

    function wireButtons() {
      const removeBtn = document.getElementById('removeJBBtn');
      const sideStoreBtn = document.getElementById('installSideStoreBtn');
      const repoBtn = document.getElementById('openRepoBtn');
      const showScriptBtn = document.getElementById('showScriptBtn');
      const openTermBtn = document.getElementById('openTerminalBtn');
      const mysteryBtn = document.getElementById('mysteryBtn');
      if (removeBtn) removeBtn.addEventListener('click', () => {
        showAlert("I apologize");
      });
      if (sideStoreBtn) sideStoreBtn.addEventListener('click', () => {
        window.open('https://sidestore.io#get-started', '_blank');
      });
      if (repoBtn) repoBtn.addEventListener('click', () => {
        window.open('https://github.com/wheatbread2056/wormJB', '_blank');
      });
      if (showScriptBtn) showScriptBtn.addEventListener('click', () => {
        window.open('https://github.com/wheatbread2056/wormJB/blob/main/jb/main.sh', '_blank');
      });
      if (openTermBtn) openTermBtn.addEventListener('click', () => {
        // Best-effort open A-Shell
        window.location.href = 'ashell://';
      });
      if (mysteryBtn) mysteryBtn.addEventListener('click', () => {
        showAlert('Absolutely nothing happened.');
      });
    }
    wireButtons();

    // Device hash copy wiring
    function getDeviceHash() {
      let h = localStorage.getItem('wormjb_device_hash');
      if (!h) {
        // generate a 16-digit string with first digit 1-9
        h = String(Math.floor(Math.random()*9)+1);
        for (let i=0;i<15;i++) h += Math.floor(Math.random()*10);
        localStorage.setItem('wormjb_device_hash', h);
      }
      return h;
    }
    (function setupCopyHash(){
      const btn = document.getElementById('copyHashBtn');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        const h = getDeviceHash();
        try { await navigator.clipboard.writeText(h); showAlert('Copied device hash: ' + h); }
        catch { showAlert('Device hash: ' + h); }
      });
    })();

    // Disable Dev Mode button
    (function setupDisableDevMode() {
      const btn = document.getElementById('disableDevBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        localStorage.removeItem('devUnlocked');
        // Remove Dev tab if present
        const devTab = document.querySelector('.tab[data-tab="devsettings"]');
        if (devTab) devTab.remove();
        updateDevUI();
        showAlert('Developer mode disabled');
        // If currently on devsettings, go home
        const activeDev = document.getElementById('devsettings').classList.contains('active');
        if (activeDev) switchTab('home');
        // Re-render tweaks to hide dev-only Settings buttons
        renderTweaks();
      });
    })();

    // ---------- audio loop support ----------
    (function setupLoopingAudio() {
      const audio = document.getElementById('bgAudio');
      const toggle = document.getElementById('audioToggleBtn');
      const state = document.getElementById('audioState');
      if (!audio || !toggle || !state) return;

      // handle space in filename
      const src = encodeURI('assets/test 104.mp3');
      audio.src = src;
  // Looping is enabled by default (user requested)
      audio.loop = true;
      audio.volume = 0.8;

      function updateUI() {
        // show whether looping is enabled and whether playback is active
        state.textContent = audio.loop ? (audio.paused ? 'on (paused)' : 'on') : 'off';
        toggle.textContent = audio.paused ? 'Play Looping Audio' : 'Pause Audio';
      }

      // Try immediate play; if blocked, start playback on first user interaction
      const musicDisabled = localStorage.getItem(MUSIC_DISABLED_KEY) === 'true';
      if (musicDisabled) {
        toggle.style.display = 'none';
        state.textContent = 'off';
      } else {
        audio.play().then(() => {
          updateUI();
        }).catch(() => {
        // Autoplay blocked; set UI and wait for first user gesture
        updateUI();
        const startOnGesture = () => {
          audio.play().then(() => updateUI()).catch(() => {});
        };
        // Use pointerdown to catch touch/click quickly; once-only listener
        document.addEventListener('pointerdown', startOnGesture, { once: true, capture: true });
        // also listen for keydown as a fallback
        document.addEventListener('keydown', startOnGesture, { once: true, capture: true });
        });
      }

      toggle.addEventListener('click', () => {
        if (audio.paused) {
          audio.play().then(() => updateUI()).catch(() => {
            showAlert('Playback blocked by browser. Tap anywhere to start audio.');
          });
        } else {
          audio.pause();
          updateUI();
        }
      });

      // initialize UI
      updateUI();
    })();

    // ---------- Color utilities for tweak background brightness inversion (dark mode only) ----------
    function isDarkMode() {
      return document.documentElement.classList.contains('dark');
    }

    function parseHexColor(hex) {
      if (!hex) return { r: 255, g: 255, b: 255, a: 1 };
      hex = String(hex).trim();
      if (hex[0] === '#') hex = hex.slice(1);
      if (hex.length === 3) {
        const r = parseInt(hex[0] + hex[0], 16);
        const g = parseInt(hex[1] + hex[1], 16);
        const b = parseInt(hex[2] + hex[2], 16);
        return { r, g, b, a: 1 };
      }
      if (hex.length === 4) {
        const r = parseInt(hex[0] + hex[0], 16);
        const g = parseInt(hex[1] + hex[1], 16);
        const b = parseInt(hex[2] + hex[2], 16);
        const a = parseInt(hex[3] + hex[3], 16) / 255;
        return { r, g, b, a };
      }
      if (hex.length === 6 || hex.length === 8) {
        const r = parseInt(hex.slice(0, 2), 16);
        const g = parseInt(hex.slice(2, 4), 16);
        const b = parseInt(hex.slice(4, 6), 16);
        const a = hex.length === 8 ? parseInt(hex.slice(6, 8), 16) / 255 : 1;
        return { r, g, b, a };
      }
      // Not a hex; fallback by letting CSS handle it
      return null;
    }

    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max - min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      return { h, s, l };
    }

    function hslToRgb(h, s, l) {
      let r, g, b;
      if (s === 0) {
        r = g = b = l; // achromatic
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
    }

    function formatColor({ r, g, b, a }) {
      a = (a == null ? 1 : a);
      if (a >= 1) {
        const toHex = (n) => n.toString(16).padStart(2, '0');
        return '#' + toHex(r) + toHex(g) + toHex(b);
      }
      return `rgba(${r}, ${g}, ${b}, ${Math.round(a * 1000) / 1000})`;
    }

    function invertBrightnessColor(hex) {
      const rgba = parseHexColor(hex);
      if (!rgba) return hex; // unknown format, let CSS handle
      const { r, g, b, a } = rgba;
      const hsl = rgbToHsl(r, g, b);
      // Invert lightness and clamp to avoid pure black/white extremes
      const lInv = 1 - hsl.l;
      const lClamped = Math.min(0.92, Math.max(0.08, lInv));
      const { r: nr, g: ng, b: nb } = hslToRgb(hsl.h, hsl.s, lClamped);
      return formatColor({ r: nr, g: ng, b: nb, a });
    }

    function resolveTweakBg(bg) {
      // Only transform in dark mode; otherwise return as-is
      if (!isDarkMode()) return bg;
      try { return invertBrightnessColor(bg); } catch (e) { return bg; }
    }
  </script>
</body>
</html>
